<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>말씀따라 흐르는 샘물 · 달력</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --line:#e5e7eb;
      --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --accent:#0ea5e9;
      --title-size:16px; --title-size-sm:15px; --cell-min:110px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --bg:#0b0f14; --bgsoft:#0f1720; --box:#0b1220; --accent:#38bdf8; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bgsoft)}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}

    /* 상단 제목: 작게 + 위 여백 넉넉 */
    .brand{display:flex;align-items:center;gap:10px;margin:3.5em 0 14px}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 18%, transparent)}
    .title-site{margin:0;font-weight:900;letter-spacing:.02em;font-size:20px}

    .yearbar{display:flex;align-items:center;justify-content:center;gap:16px;margin:8px 0}
    .yearbar a{appearance:none;border:1px solid var(--line);background:var(--box);color:var(--fg);padding:6px 10px;border-radius:12px;text-decoration:none;font-weight:700}
    .year{font-weight:900;letter-spacing:.02em}

    .months{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px}
    .months a{border:1px solid var(--line);background:var(--box);padding:6px 10px;border-radius:12px;text-decoration:none;color:var(--fg)}
    .months a.active{outline:2px solid var(--accent)}

    .cal{background:var(--box);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line);background:color-mix(in oklab, var(--accent) 12%, var(--bg))}
    .cal .head div{padding:10px 8px;text-align:center;font-weight:700}
    .cal .grid{display:grid;grid-template-columns:repeat(7,1fr)}

    .day{min-height:var(--cell-min);border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px}
    .day:nth-child(7n){border-right:none}
    .date{font-weight:800;font-size:13px;opacity:.95}
    .date a{color:inherit;text-decoration:none;display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:rgba(0,0,0,.02)}

    /* 제목: 둥근 박스(titleCard) */
    .titleCard{
      margin-top: 4px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: rgba(0,0,0,.03);
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .titleCard .title a{
      font-size: var(--title-size);
      line-height: 1.35;
      font-weight: 700;
      text-decoration: none;
      display: block;
      overflow: hidden; text-overflow: ellipsis;
    }
    .titleCard .title a:hover{ text-decoration: underline; }

    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 8%, transparent), transparent)}
    .today{outline:2px solid var(--accent); outline-offset:-2px;}
    /* 상태배지 완전 제거: 요소도 만들지 않으므로 숨김 스타일 불필요 */
    @media (max-width:720px){ .day{min-height:96px} .titleCard .title a{font-size:var(--title-size-sm)} }
  </style>
</head>
<body>
  <noscript>이 페이지는 자바스크립트가 필요합니다.</noscript>
  <div class="wrap">
    <header class="brand">
      <span class="dot" aria-hidden="true"></span>
      <h1 class="title-site">말씀따라 흐르는 샘물</h1>
    </header>

    <nav class="yearbar" aria-label="연도 네비게이션">
      <a id="yearPrev" href="#" aria-label="이전 연도">◀</a>
      <div class="year" id="yearLabel">—</div>
      <a id="yearNext" href="#" aria-label="다음 연도">▶</a>
    </nav>
    <div class="months" id="months"></div>

    <section class="cal">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

  <!-- 스크립트는 이 한 개만! (정규식/async 없음) -->
  <script type="text/javascript">
  (function(){
    // ===== URL (가드 포함) =====
    var u = new URL(location.href);

    // year 가드 (숫자 아니면 올해)
    var rawY = u.searchParams.get('y') || u.searchParams.get('year');
    var Y = parseInt(rawY, 10);
    if (!Number.isFinite(Y)) { Y = (new Date()).getFullYear(); }

    // month 가드 (1~12 아니면 현재 월)
    var rawM = u.searchParams.get('m') || u.searchParams.get('month');
    var M = parseInt(rawM, 10);
    if (!(M >= 1 && M <= 12)) { M = (new Date()).getMonth() + 1; }

    // 언어
    var lang = (u.searchParams.get('lang') || 'ko').toLowerCase();

    // ===== 요소 =====
    var grid      = document.getElementById('grid');
    var yearLabel = document.getElementById('yearLabel');
    var yearPrev  = document.getElementById('yearPrev');
    var yearNext  = document.getElementById('yearNext');
    var monthsBar = document.getElementById('months');

    // ===== 유틸 =====
    function pad2(n){ return (n<10?'0':'')+n; }
    function looksUrl(s){ if(!s) return false; s=String(s); return s.indexOf('http://')===0 || s.indexOf('https://')===0; }

    // 항상 index02.html로 이동(연/월 네비 고정)
    function linkTo(y,m){
      return location.origin + '/streams-of-the-word/index02.html'
           + '?lang=' + encodeURIComponent(lang)
           + '&y='   + encodeURIComponent(y)
           + '&m='   + encodeURIComponent(m);
    }

    function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
    function startWeekday(y,m){ return new Date(y,m-1,1).getDay(); }

    // ===== 상단 바 =====
    if(yearLabel) yearLabel.textContent = Y+'년';
    if(yearPrev)  yearPrev.href = linkTo(Y-1, M);
    if(yearNext)  yearNext.href = linkTo(Y+1, M);
    if(monthsBar){
      monthsBar.innerHTML='';
      for(var mm=1; mm<=12; mm++){
        var a=document.createElement('a');
        a.href = linkTo(Y, mm);
        a.textContent = mm+'월';
        if(mm===M) a.classList.add('active');
        monthsBar.appendChild(a);
      }
    }

    // ===== 숫자 그리드 생성 =====
    (function ensureGrid(){
      var total=daysInMonth(Y,M), start=startWeekday(Y,M);
      grid.innerHTML='';
      var cells=Math.ceil((start+total)/7)*7;
      var today=new Date(), isThis=(today.getFullYear()===Y)&&((today.getMonth()+1)===M);
      for(var i=0;i<cells;i++){
        var day=(i>=start&&(i-start)<total)?(i-start+1):null;
        var cell=document.createElement('div'); cell.className='day';
        if(day===null){ cell.classList.add('empty'); }
        else{
          var d=document.createElement('div'); d.className='date'; d.textContent=String(day); cell.appendChild(d);
          if(isThis && day===today.getDate()) cell.classList.add('today');
        }
        grid.appendChild(cell);
      }
    })();

    // ===== 데이터 로드 (저장소 베이스 고정) =====
    function loadData(y,m,done){
      var fname=y+"-"+pad2(m)+".txt";
      var repoBase="/streams-of-the-word/"; // 저장소명이 다르면 여기만 수정
      var candidates=[
        repoBase+"data/"+fname, // 최우선 절대경로
        "data/"+fname,
        "../data/"+fname,
        "../../data/"+fname
      ];
      var i=0;
      function next(){
        if(i>=candidates.length){ done({}); return; }
        var url=candidates[i++];
        fetch(url,{cache:"no-store"}).then(function(res){
          if(!res.ok) throw new Error("HTTP "+res.status);
          return res.text();
        }).then(function(txt){
          // 줄 분리(정규식 없이 CR 제거)
          var arr=txt.split("\n"), lines=[], k, line;
          for(k=0;k<arr.length;k++){
            line=arr[k];
            if(line && line.length && line.charCodeAt(line.length-1)===13) line=line.slice(0,-1);
            lines.push(line);
          }
          // 파싱
          var map={}, j, raw, p, t;
          for(j=0;j<lines.length;j++){
            raw=(lines[j]||'').trim(); if(!raw || raw.charAt(0)==='#') continue;
            p=raw.split("|"); for(t=0;t<p.length;t++){ p[t]=(p[t]||"").trim(); }
            var day=parseInt(p[0],10); if(!day||isNaN(day)) continue;
            var title=p[1]||"";
            // 링크 우선: p[3](티스토리) → p[2]가 URL이면 그걸로 → p[4](네이버)
            var first=""; if(p.length>=4){ first=p[3]; } else if(p.length>=3 && looksUrl(p[2])){ first=p[2]; }
            var second=p[4]||"";
            var href=looksUrl(first)?first:(looksUrl(second)?second:"");
            map[day]={title:title, href:href};
          }
          done(map);
        }).catch(function(){ next(); });
      }
      next();
    }

    // ===== 제목/링크 채우기 (10월: 전 날짜에 빈 박스 생성) =====
    function fill(map){
      var cells = grid.querySelectorAll('.day');
      var wantEmptyCards = (M === 10); // 10월은 빈 박스도 표시

      for (var i=0; i<cells.length; i++){
        var cell = cells[i];
        if (cell.classList.contains('empty')) continue;

        var dateEl = cell.querySelector('.date');
        if (!dateEl) continue;

        var dd = parseInt(String(dateEl.textContent||'').trim(), 10);
        var info = map[dd]; // 있을 수도, 없을 수도

        // 날짜 숫자에도 링크 (데이터가 있을 때)
        if (info && info.href && !dateEl.querySelector('a')){
          var da = document.createElement('a');
          da.href = info.href; da.target = '_blank'; da.rel = 'noopener';
          da.textContent = String(dd);
          dateEl.textContent = '';
          dateEl.appendChild(da);
        }

        // 제목 박스 처리
        if (wantEmptyCards || (info && info.title)){
          var box = cell.querySelector('.titleCard');
          if (!box){
            box = document.createElement('div');
            box.className = 'titleCard';
            cell.appendChild(box);
          } else {
            box.innerHTML = '';
          }

          // 데이터가 있을 때만 제목/링크 채움
          if (info && info.title){
            var tDiv = document.createElement('div');
            tDiv.className = 'title';
            if (info.href){
              var a = document.createElement('a');
              a.href = info.href; a.target = '_blank'; a.rel = 'noopener';
              a.textContent = info.title;
              tDiv.appendChild(a);
            } else {
              tDiv.textContent = info.title;
            }
            box.appendChild(tDiv);
          }
          // 데이터가 없으면 빈 박스 그대로 둠
        }
      }
    }

    // 실행
    loadData(Y,M,function(map){ try{ fill(map||{}); }catch(e){} });
  })();
  </script>
</body>
</html>
