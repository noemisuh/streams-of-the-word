<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{ --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
         --accent:#0ea5e9; --bg:#ffffff; --box:#ffffff; --bgsoft:#f8fafc; }
  @media (prefers-color-scheme: dark){
    :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#334155; --line-strong:#475569;
           --accent:#38bdf8; --bg:#0b0f14; --box:#0f1720; --bgsoft:#0f1720; }
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
  }
  .wrap{max-width:1080px;margin:0 auto;padding:56px 16px 24px;}
  .top{display:grid;grid-template-rows:40px 36px 40px;row-gap:12px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:18px;}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);}
  .yearbar{display:flex;justify-content:center;align-items:center;gap:16px;}
  .yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg);}
  .yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg);}
  .monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px;}
  .monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box);}
  .monthbar a.active{border-color:var(--accent);outline:2px solid rgba(56,189,248,.25);}
  .cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box);}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft);}
  .cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px;position:relative;}
  .grid .cell:nth-child(7n){border-right:none;}
  .cellbox{
    position:relative; display:flex; flex-direction:column;
    width:100%; min-height:140px; padding:28px 16px 16px;
    border:1px solid var(--line); border-radius:14px; background:rgba(14,165,233,0.10);
    text-decoration:none; color:inherit; transition:box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  a.cellbox:hover{ box-shadow:0 2px 10px rgba(0,0,0,.06); border-color:var(--accent); background:rgba(14,165,233,0.14); }
  .dnum-badge{
    position:absolute; left:10px; top:10px; z-index:3;
    font-size:12px; color:var(--muted); padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:var(--box);
  }
  .center{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:6px 4px; }
  .title-center{
    max-width:100%; font-size:16px; line-height:1.4; white-space:normal; word-break:keep-all; overflow:hidden;
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; text-wrap:balance; margin:0;
  }
  .ref{margin-top:8px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .more{font-size:11px;color:var(--muted);margin-top:4px;}
  @media (prefers-color-scheme: dark){
    .cellbox{ background:rgba(56,189,248,0.12); }
    .dnum-badge{ background:#0f1720; border-color:#334155; color:#9ca3af; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <section class="top" aria-label="상단">
      <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
      <nav class="yearbar" aria-label="년도">
        <a id="prevYear" href="#" onclick="goYear(-1);return false;">◀</a>
        <span class="yr" id="yearLabel">0000</span>
        <a id="nextYear" href="#" onclick="goYear(1);return false;">▶</a>
      </nav>
      <nav class="monthbar" id="monthbar" aria-label="월"></nav>
    </section>
    <section class="cal" aria-label="달력">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

<script>
(function(){
  /* ===== URL 파라미터 ===== */
  var qs = location.search || "";
  function pickLastNum(keyFallback, fallback){
    var u = new URL(location.href);
    var v = u.searchParams.get(keyFallback);
    var re = new RegExp("(?:\\b"+keyFallback+"\\b|\\byear\\b|\\bmonth\\b|\\bm\\b|\\by\\b)\\s*=\\s*(\\d{1,4})","gi");
    var mm, last=null; while((mm = re.exec(qs))){ last = mm[1]; }
    var cand = (last!==null)? last : v; var n = parseInt(cand,10);
    return (isFinite(n)? n : fallback);
  }
  var today = new Date();
  var y = pickLastNum('y', today.getFullYear());
  if(!(y>=1900 && y<=9999)) y = today.getFullYear();
  var m = pickLastNum('m', (today.getMonth()+1));
  if(!(m>=1 && m<=12)) m = today.getMonth()+1;

  /* ===== 이동 함수 ===== */
  window.goYear = function(delta){
    var u = new URL(window.location.href);
    var cy = parseInt(u.searchParams.get('y')||y,10) || new Date().getFullYear();
    var cm = parseInt(u.searchParams.get('m')||m,10) || (new Date().getMonth()+1);
    u.searchParams.set('y', String(cy + delta));
    u.searchParams.set('m', String(cm));
    window.location.href = u.toString();
  };

  /* ===== 상단 표시/월바 ===== */
  document.getElementById('yearLabel').textContent = y;
  (function buildMonthbar(){
    var box = document.getElementById('monthbar'); box.innerHTML='';
    for(var i=1;i<=12;i++){
      var u = new URL(window.location.href);
      u.searchParams.set('y', String(y));
      u.searchParams.set('m', String(i));
      var a = document.createElement('a');
      a.textContent = i+'월'; a.href = u.toString();
      if(i===m) a.className='active';
      a.onclick = function(e){ e.preventDefault(); window.location.href = this.href; };
      box.appendChild(a);
    }
  })();

  /* ===== 데이터 로딩: 현재 폴더의 data만 사용 ===== */
  var dayMap = Object.create(null);

  function isUrl(s){ return /^https?:\/\//i.test(s||''); }
  function looksLikeVerse(s){ return /\b[가-힣A-Za-z]{1,4}\s*\d+\s*[:.:]\s*\d+/.test(s||''); }
  function clean(s){ return (s||'').replace(/^"(.*)"$/, '$1').trim(); }

  // 다양한 구분자 허용: |, 풀와이드 ｜, 탭, 콤마
  var SPLIT_RE = /\s*[\|\uFF5C,\t]\s*/g;

  function titleScore(s){
    s = clean(s); if(!s) return -1;
    if(isUrl(s)) return -1;
    var base = (s.match(/[\p{L}\p{N}]/gu)||[]).length;
    if(looksLikeVerse(s)) base -= 6;
    if(/^제목\s*[:：]/.test(s)) base += 5;
    if(s.length <= 1) base -= 10;
    return base;
  }

  function parseText(text){
    if(text && text.charCodeAt && text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    var lines = (text||'').replace(/\r\n?/g,'\n').split('\n');
    for(var i=0;i<lines.length;i++){
      var raw = lines[i];
      if(!raw) continue;
      var line = raw.trim();
      if(!line || line.startsWith('#') || line.startsWith('//')) continue;

      // DD로 시작하지 않는 줄 무시
      var mday = line.match(/^\s*(\d{1,2})\s*[\|\uFF5C,\t]/);
      if(!mday){ continue; }
      var dd = parseInt(mday[1],10); if(!(dd>=1 && dd<=31)) continue;

      // 첫 구분자 뒤의 나머지를 분해
      var restStr = line.replace(/^\s*\d{1,2}\s*[\|\uFF5C,\t]\s*/, '');
      var parts = restStr.split(SPLIT_RE).map(clean).filter(function(s){ return s!==''; });
      if(parts.length === 0){
        if(!dayMap[dd]) dayMap[dd] = {title:'', ref:'', url:'', extraCount:0};
        else dayMap[dd].extraCount++;
        continue;
      }

      // URL 추출 (맨 앞/중간 어디든)
      var url = '';
      for(var uidx=0; uidx<parts.length; uidx++){
        if(isUrl(parts[uidx])){ url = parts[uidx]; parts.splice(uidx,1); break; }
      }

      // 제목 후보 선정
      var best = '';
      var bestScore = -1;
      for(var p=0;p<parts.length;p++){
        var s = parts[p].replace(/^제목\s*[:：]\s*/,'');
        var sc = titleScore(s);
        if(sc > bestScore){ bestScore = sc; best = s; }
      }

      // ref 선택: 제목으로 쓰지 않은 첫 항목(성구/메모 등)
      var ref = '';
      for(var q=0;q<parts.length;q++){
        var s2 = parts[q].replace(/^제목\s*[:：]\s*/,'');
        if(s2 === best) continue;
        ref = parts[q]; break;
      }

      if(!dayMap[dd]) dayMap[dd] = {title:best||'', ref:ref||'', url:url||'', extraCount:0};
      else dayMap[dd].extraCount++;
    }
  }

  function loadData(){
    var ym = y + '-' + String(m).padStart(2,'0') + '.txt';
    var url = 'data/' + ym;
    fetch(url, {cache:'no-store'})
      .then(function(r){ return r.ok ? r.text() : ''; })
      .then(function(t){ if(t && t.trim()){ parseText(t); } render(); })
      .catch(function(){ render(); });
  }

  /* ===== 렌더 ===== */
  function render(){
    var grid = document.getElementById('grid'); grid.innerHTML='';
    var first = new Date(y, m-1, 1);
    var start = first.getDay();
    var days = new Date(y, m, 0).getDate();

    var cells = [];
    for(var i=0;i<start;i++) cells.push({empty:true});
    for(var d=1; d<=days; d++) cells.push({empty:false, day:d, info:dayMap[d]});
    while(cells.length%7!==0) cells.push({empty:true});

    for(var k=0;k<cells.length;k++){
      var c = cells[k];
      var cell = document.createElement('div');
      cell.className = 'cell' + (c.empty?' is-empty':'');
      if(c.empty){ grid.appendChild(cell); continue; }

      var info = c.info || {title:'', ref:'', url:'', extraCount:0};
      var box = (info.url) ? document.createElement('a') : document.createElement('div');
      box.className = 'cellbox';
      if(info.url){ box.href = info.url; box.target = '_blank'; box.rel='noopener'; }

      var badge = document.createElement('div'); badge.className = 'dnum-badge'; badge.textContent = c.day; box.appendChild(badge);

      var center = document.createElement('div'); center.className = 'center';
      var titleEl = document.createElement('div'); titleEl.className = 'title-center';
      titleEl.textContent = info.title || ''; center.appendChild(titleEl);
      if(info.ref){ var r = document.createElement('div'); r.className='ref'; r.textContent = info.ref; center.appendChild(r); }
      if(info.extraCount>0){ var mline = document.createElement('div'); mline.className='more'; mline.textContent = '+'+ info.extraCount +' 더 있음'; center.appendChild(mline); }

      box.appendChild(center); cell.appendChild(box); grid.appendChild(cell);
    }
  }

  loadData();
})();
</script>
</body>
</html>
