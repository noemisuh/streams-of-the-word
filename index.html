<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
    --accent:#0ea5e9; --accent-weak:#e0f2fe; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#e5e7eb; --muted:#9ca3af; --line:#26303a; --line-strong:#334155;
      --accent:#38bdf8; --accent-weak:#0b2a3a; --bg:#0b0f14; --bgsoft:#0f1720; --box:#0f1720;
    }
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
  }
  /* 위 여백 넉넉히(2칸) + 브랜드 크기 축소 */
  .wrap{max-width:1080px;margin:0 auto;padding:56px 16px 24px;}
  .top{display:grid;grid-template-rows:40px 36px 40px;row-gap:12px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:18px;}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);}
  .yearbar{display:flex;justify-content:center;align-items:center;gap:16px;}
  .yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg);}
  .yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg);}
  .monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px;}
  .monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box);}
  .monthbar a.active{border-color:var(--accent);outline:2px solid var(--accent-weak);}

  /* ===== 달력 ===== */
  .cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box);}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft);}
  .cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{
    border-right:1px solid var(--line);border-bottom:1px solid var(--line);
    padding:10px; display:flex; position:relative;
  }
  .grid .cell:nth-child(7n){border-right:none;}
  .grid .cell.is-empty{background:linear-gradient(180deg, rgba(0,0,0,0.02) 0 0) top/100% 44px no-repeat;}

  /* ✅ 셀 전체가 둥근 네모칸(클릭 가능) + 제목 중앙정렬 */
  .cellbox{
    position:relative;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    width:100%; min-height:130px;
    padding:16px;
    border:1px solid var(--line);
    border-radius:14px;
    background:rgba(14,165,233,0.08);
    text-decoration:none; color:inherit;
    transition:transform .05s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  a.cellbox:hover{ box-shadow:0 2px 10px rgba(0,0,0,.06); border-color:var(--accent); background:rgba(14,165,233,0.12); }
  a.cellbox:active{ transform:translateY(1px); }

  /* 날짜 뱃지: 좌상단, 제목과 분리 */
  .dnum-badge{
    position:absolute; left:10px; top:10px;
    font-size:12px; color:var(--muted);
    padding:2px 6px; border:1px solid var(--line); border-radius:8px;
    background:var(--box);
  }

  /* 제목(중앙) */
  .title-center{
    max-width:100%;
    font-size:15px; line-height:1.35; text-align:center;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* 본문표기와 추가개수: 제목 아래, 연한 톤 */
  .ref{margin-top:6px;font-size:12px;color:var(--muted);
       white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center;}
  .more{margin-top:2px;font-size:11px;color:var(--muted);text-align:center;}

  @media (prefers-color-scheme: dark){
    .cellbox{ background:rgba(56,189,248,0.12); }
    .dnum-badge{ background:#0f1720; border-color:#334155; color:#9ca3af; }
  }
  @media (max-width:640px){
    .cellbox{min-height:118px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <section class="top" aria-label="상단">
      <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
      <nav class="yearbar" aria-label="년도">
        <a id="prevYear" href="#">◀</a>
        <span class="yr" id="yearLabel">2025</span>
        <a id="nextYear" href="#">▶</a>
      </nav>
      <nav class="monthbar" id="monthbar" aria-label="월"></nav>
    </section>

    <section class="cal" aria-label="달력">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

  <script>
  (function(){
    /* ===== URL 파라미터 견고 파서 ===== */
    var qs = location.search || "";
    function pickLastNum(keyFallback, fallback){
      var u = new URL(location.href);
      var v = u.searchParams.get(keyFallback);
      var re = new RegExp("(?:\\b"+keyFallback+"\\b|\\byear\\b|\\bmonth\\b|\\bm\\b|\\by\\b)\\s*=\\s*(\\d{1,4})","gi");
      var mm, last=null;
      while((mm = re.exec(qs))){ last = mm[1]; }
      var cand = (last!==null)? last : v;
      var n = parseInt(cand,10);
      return (isFinite(n)? n : fallback);
    }
    var today = new Date();
    var y = pickLastNum('y', today.getFullYear());
    if(!(y>=1900 && y<=9999)) y = today.getFullYear();
    var m = pickLastNum('m', (today.getMonth()+1));
    if(!(m>=1 && m<=12)) m = today.getMonth()+1;

    /* 절대 URL로 반환 → 년도 링크 확실히 동작 */
    function makeUrl(nextY, nextM){
      var u = new URL(location.href);
      u.searchParams.set('y', String(nextY));
      u.searchParams.set('m', String(nextM));
      return u.href;  // 전체 URL
    }

    document.getElementById('yearLabel').textContent = y;
    document.getElementById('prevYear').href = makeUrl(y-1, m);
    document.getElementById('nextYear').href = makeUrl(y+1, m);

    (function buildMonthbar(){
      var box = document.getElementById('monthbar'); box.innerHTML='';
      for(var i=1;i<=12;i++){
        var a = document.createElement('a');
        a.textContent = i+'월';
        a.href = makeUrl(y, i);
        if(i===m) a.className='active';
        box.appendChild(a);
      }
    })();

    /* ===== 데이터 로딩 ===== */
    var ym = y + '-' + String(m).padStart(2,'0') + '.txt';
    var basePath = location.pathname.replace(/[^\/]*$/, '');
    var candidates = [ basePath + 'data/' + ym, '/data/' + ym ];

    var dayMap = Object.create(null);

    function parseText(text){
      if(text && text.charCodeAt && text.charCodeAt(0)===0xFEFF) text = text.slice(1);
      var lines = (text||'').replace(/\r\n?/g,'\n').split('\n');
      for(var i=0;i<lines.length;i++){
        var line = lines[i].trim(); if(!line) continue;
        var parts = line.split('|'); if(parts.length<2) continue;
        var dd = parseInt((parts[0]||'').trim(),10);
        if(!(dd>=1 && dd<=31)) continue;
        var title = (parts[1]||'').trim();
        var ref   = (parts[2]||'').trim();
        var url   = (parts[3]||'').trim();
        if(!dayMap[dd]) dayMap[dd] = {title:title, ref:ref, url:url, extraCount:0};
        else dayMap[dd].extraCount++;
      }
    }

    function tryFetch(i){
      if(i>=candidates.length){ render(); return; }
      fetch(candidates[i], {cache:'no-store'})
        .then(function(r){ return r.ok ? r.text() : ''; })
        .then(function(t){ if(t && t.trim().length){ parseText(t); render(); } else tryFetch(i+1); })
        .catch(function(){ tryFetch(i+1); });
    }
    tryFetch(0);

    /* ===== 렌더: URL 있으면 셀 전체를 <a class="cellbox">로 ===== */
    function render(){
      var grid = document.getElementById('grid'); grid.innerHTML='';
      var first = new Date(y, m-1, 1);
      var start = first.getDay();
      var days = new Date(y, m, 0).getDate();

      var cells = [];
      for(var i=0;i<start;i++) cells.push({empty:true});
      for(var d=1; d<=days; d++) cells.push({empty:false, day:d, info:dayMap[d]});
      while(cells.length%7!==0) cells.push({empty:true});

      for(var k=0;k<cells.length;k++){
        var c = cells[k];
        var cell = document.createElement('div');
        cell.className = 'cell' + (c.empty?' is-empty':'');
        if(c.empty){ grid.appendChild(cell); continue; }

        var info = c.info;
        var box;
        if(info && info.url){
          box = document.createElement('a');
          box.href = info.url; box.target = '_blank'; box.rel='noopener';
          box.className = 'cellbox';
        }else{
          box = document.createElement('div');
          box.className = 'cellbox';
        }

        /* 날짜 배지 (좌상단 고정) */
        var badge = document.createElement('div');
        badge.className = 'dnum-badge';
        badge.textContent = c.day;
        box.appendChild(badge);

        /* 제목 중앙 */
        var titleEl = document.createElement('div');
        titleEl.className = 'title-center';
        titleEl.textContent = (info && info.title) ? info.title : '';
        box.appendChild(titleEl);

        /* 본문/추가 갯수 (있을 때만) */
        if(info && info.ref){
          var r = document.createElement('div'); r.className='ref';
          r.textContent = info.ref; box.appendChild(r);
        }
        if(info && info.extraCount>0){
          var mline = document.createElement('div'); mline.className='more';
          mline.textContent = '+'+ info.extraCount +' 더 있음'; box.appendChild(mline);
        }

        cell.appendChild(box);
        grid.appendChild(cell);
      }
    }
  })();
  </script>
</body>
</html>
