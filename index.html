<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë§ì”€ë”°ë¼ íë¥´ëŠ” ìƒ˜ë¬¼</title>
<meta name="color-scheme" content="light dark">

<style>
  :root {
    --fg:#111827; --muted:#6b7280; --line:#d1d5db; --line-strong:#9ca3af;
    --accent:#0ea5e9; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --box-line:#d1d5db; --box-tint:#f0f9ff;
  }
  @media (prefers-color-scheme: dark){
    :root { --fg:#e5e7eb; --muted:#9ca3af; --line:#2b2f36; --line-strong:#4b5563; --bg:#0b0f14; --bgsoft:#0f141a; --box:#0c1218; --box-line:#1f2937; --box-tint:#0c141c; }
    body { background: var(--bg); }
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif; color:var(--fg); background:var(--bg); }
  .wrap { max-width: 940px; margin: 28px auto; padding: 0 12px; }

header { display:flex; justify-content:center; align-items:center; margin:6px 0 4px; }
/* í—¤ë” ë°°ì§€ + ë§í¬ ìŠ¤íƒ€ì¼ */
.brand{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 14px;
  border:1.5px solid var(--line-strong);
  border-radius:999px;
  background:var(--bgsoft);
  text-decoration:none;   /* ë§í¬ ë°‘ì¤„ ì œê±° */
  color:inherit;          /* ë§í¬ ìƒ‰ìƒ ìƒì† */
}
.brand h1{ font-size:16px; margin:0; letter-spacing:-0.2px; font-weight:700; }

/* ì—°ë„ ë°” (ëŠê¸´ ì¤„ ë³µêµ¬ + ì¤‘ë³µ ì œê±°) */
.yearbar{
  display:flex;
  justify-content:center;
  margin:6px 0;
}
.yearbar .year { font-size:16px; font-weight:700; letter-spacing:-0.3px; }

/* ì›” ë°” */
.monthbar { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:4px 0 10px; }
.monthbar a { text-decoration:none; color:var(--muted); padding:2px 0; font-size:14px; }
.monthbar a.active { color:var(--accent); font-weight:700; }

table.cal { 
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  table-layout:fixed;
}
.cal thead th {
  background:var(--bgsoft);
  position:sticky;
  top:0;
  z-index:1;
  font-weight:700;
  padding:8px;
  font-size:13px;
  border-bottom:2px solid var(--line-strong);
  border-top:1.5px solid var(--line-strong);
  border-left:1.5px solid var(--line-strong);
  text-align:center;
}
.cal thead th:last-child { border-right:1.5px solid var(--line-strong); }

.cal tbody td {
  padding:6px;
  position:relative;
  background:var(--bg);
  border-left:1.5px solid var(--line);
  border-bottom:1.5px solid var(--line);
}
.cal tbody tr:last-child td { border-bottom:1.5px solid var(--line-strong); }
.cal tbody td:last-child { border-right:1.5px solid var(--line-strong); }
.cal tbody td:first-child { border-left:1.5px solid var(--line-strong); }

.daynum {
  display:block;
  font-size:11px;
  color:var(--muted);
  user-select:none;
  text-align:center;
  margin-top:2px;
}

/* ìº˜ë¦°ë” ë°•ìŠ¤ */
.box {
  width:100%;
  aspect-ratio:1/1;
  margin-top:4px;
  border:1.5px solid var(--box-line);
  background:linear-gradient(180deg, var(--box-tint) 0%, var(--box) 80%);
  border-radius:12px;
  position:relative;
  overflow:hidden;
  box-shadow:0 1px 0 rgba(0,0,0,.02), 0 6px 12px rgba(0,0,0,.04);
  transition:border-color .15s, box-shadow .15s, transform .06s;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:8px 10px;
}
.box.link { cursor:pointer; }
.box.link:hover { border-color:var(--accent); box-shadow:0 1px 0 rgba(0,0,0,.03), 0 10px 18px rgba(0,0,0,.08); }
.box.link:active { transform: translateY(1px); }
a.box.link { text-decoration:none; color:inherit; display:flex; }
/* ëª¨ë°”ì¼ í„°ì¹˜ ì”ìƒ ì œê±° + í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ í‘œì‹œ */
a.box.link { -webkit-tap-highlight-color: transparent; }
a.box.link:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

.title { 
  text-align:center;
  white-space:normal;
  word-break:keep-all;
  overflow-wrap:anywhere;
  line-height:1.45;
  margin-bottom:4px;
}
.ref { text-align:center; font-size:13px; }
.box .title { font-size:14.5px; }

@media (max-width:640px){
  .wrap { margin:20px auto; }
  .brand h1 { font-size:15px; }
  .yearbar .year { font-size:15px; }
  .monthbar a { font-size:13px; }
  .cal thead th { padding:8px; font-size:12px; }
  .title { line-height:1.45; }
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="brand" id="brand-link" href="index.html?y=2025&m=09" rel="noopener">
        <h1>ë§ì”€ë”°ë¼ íë¥´ëŠ” ìƒ˜ë¬¼</h1>
      </a>
    </header>

<!-- ğŸ”Š ì›”ë³„ ì°¬ì–‘ ë¯¸ë‹ˆ í”Œë ˆì´ì–´ -->
<div id="player" style="display:flex;gap:8px;justify-content:center;align-items:center;margin:10px 0;">
  <button id="playBtn" style="padding:6px 10px;border:1px solid var(--line-strong);border-radius:10px;background:var(--bgsoft);cursor:pointer">
    ğŸ”Š ì°¬ì–‘ ì¬ìƒ
  </button>
  <!-- MP3ìš© ì˜¤ë””ì˜¤ (ê¸°ë³¸ ìˆ¨ê¹€) -->
  <audio id="audio" preload="none" controls style="display:none;"></audio>
  <!-- ìœ íŠœë¸Œìš© iframe (ê¸°ë³¸ ìˆ¨ê¹€) -->
  <iframe id="yt" width="320" height="180" style="display:none;border:none"
          src="" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
</div>

    <div class="yearbar" aria-label="ì—°ë„">
      <div class="year" id="year-label"></div>
    </div>
    <div class="monthbar" id="monthbar" aria-label="ì›” ì„ íƒ"></div>

    <table class="cal" aria-label="ì›”ë ¥" id="cal">
      <thead>
        <tr><th scope="col">ì¼</th><th scope="col">ì›”</th><th scope="col">í™”</th><th scope="col">ìˆ˜</th><th scope="col">ëª©</th><th scope="col">ê¸ˆ</th><th scope="col">í† </th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
/* ======================================
   ì„¤ì • (Config)
====================================== */
const DATA_DIR = 'data';
const HYMN = {
  "2025-09": { type: "yt",  src: "ì˜ìƒID_ì—¬ê¸°ì—",                   title: "2025ë…„ 9ì›” ì°¬ì–‘" },
  // "2025-10": { type: "mp3", src: "https://example.com/oct.mp3",   title: "2025ë…„ 10ì›” ì°¬ì–‘" },
};
const DEFAULT_YEAR  = 2025;   // ym íŒŒë¼ë¯¸í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ì—°ë„
const DEFAULT_MONTH = 9;      // ym íŒŒë¼ë¯¸í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ì›” (1~12)

/* ======================================
   ìœ íŠœë¸Œ ID íŒŒì„œ & ì°¬ì–‘ í”Œë ˆì´ì–´
====================================== */
function parseYouTubeId(input){
  if(!input) return '';
  if(/^https?:\/\//i.test(input)){
    const m = input.match(/(?:v=|youtu\.be\/|embed\/)([A-Za-z0-9_-]{6,})/);
    return m ? m[1] : '';
  }
  return input; // ì´ë¯¸ IDë¼ë©´ ê·¸ëŒ€ë¡œ
}

function setupHymnPlayer(year, month){
  const ymKey = `${year}-${String(month).padStart(2,'0')}`;
  const info  = HYMN[ymKey];

  const playBtn = document.getElementById('playBtn');
  const audio   = document.getElementById('audio');
  const yt      = document.getElementById('yt');

  // ì´ˆê¸°í™”
  if (audio) { try { audio.pause(); } catch(_){}; audio.src = ""; audio.style.display = "none"; }
  if (yt)    { yt.style.display = "none"; yt.src = "about:blank"; }
  if (playBtn) playBtn.disabled = !info;

  if (!info){
    if (playBtn) playBtn.textContent = "ğŸ”‡ ì´ë²ˆ ë‹¬ ì°¬ì–‘ ì—†ìŒ";
    return;
  }
  if (playBtn) playBtn.textContent = `ğŸ”Š ${info.title} ì¬ìƒ`;

  if (playBtn) {
    playBtn.onclick = ()=>{
      if (info.type === "mp3"){
        if (audio){
          audio.src = info.src;
          audio.style.display = "block";
          audio.play().catch(()=>{});
        }
      } else if (info.type === "yt"){
        if (!yt) return;
        const vid = parseYouTubeId(info.src);
        const url = `https://www.youtube.com/embed/${vid}?autoplay=1&loop=1&playlist=${vid}&mute=1`;
        setTimeout(()=>{ yt.src = url; yt.style.display = "block"; }, 50);
      }
    };
  }

  // autoplay=1 ì´ë©´ ë²„íŠ¼ ì¤€ë¹„ëœ ë’¤ ìë™ í´ë¦­ (ìŠ¤ì½”í”„ ì˜¤ë¥˜ ë°©ì§€)
  const params = new URL(location.href).searchParams;
  if (params.get('autoplay') === '1' && playBtn && !playBtn.disabled){
    setTimeout(()=> playBtn.click(), 150);
  }
}

/* ======================================
   ìœ í‹¸(Utilities)
====================================== */
const pad2 = n => String(n).padStart(2,'0');
const qs   = (s,r=document)=>r.querySelector(s);
const isUrl = (s) => /^https?:\/\//i.test(s||'');

function getSourcePref(){
  const p = new URL(location.href).searchParams.get('src');
  if (p === 'naver' || p === 'tistory') return p;
  const r = document.referrer || '';
  if (/blog\.naver\.com/i.test(r)) return 'naver';
  if (/tistory\.com/i.test(r))     return 'tistory';
  return '';
}

/* ======================================
   ë°ì´í„° ë¡œë”© (ì›”ë³„ â†’ ì—°ê°„ í´ë°±)
   - ì•„ë˜ íŒŒì„œ/ë¡œë”ëŠ” ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼ ë™ì‘
====================================== */
async function tryFetch(path){
  try{
    const r = await fetch(`${path}?v=${Date.now()}`); // ìºì‹œë²„ìŠ¤í„°
    if(!r.ok) return null;
    return await r.text();
  }catch(e){ return null; }
}

// ì›”ë³„ í¬ë§·: "DD|ì œëª©|ë³¸ë¬¸(ì„ íƒ)|ë„¤ì´ë²„/í‹°ìŠ¤í† ë¦¬ URL 2ê°œ" (ìˆœì„œ ìƒê´€ì—†ìŒ)
function parseMonthly(text){
  const host  = u => { try{ return new URL(u).host; }catch(_){ return ''; } };

  return text
    .replace(/^\uFEFF/, '') // BOM ì œê±°
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l && !l.startsWith('#'))
    .map(l=>{
      const parts = l.split('|').map(s=>(s||'').trim());
      const day   = Number(parts[0])||0;

      const rest   = parts.slice(1);
      const isUrl  = (s)=>/^https?:\/\//i.test(s||'');
      const urls   = rest.filter(isUrl);
      const texty  = rest.filter(x=>!isUrl(x));

      const title  = texty[0] || '';
      const ref    = texty[1] || '';

      let naver='', tistory='';
      for (const u of urls){
        const h = host(u);
        if (h.includes('blog.naver.com')) naver   ||= u;
        if (h.includes('tistory.com'))    tistory ||= u;
      }
      const url = urls[0] || ''; // í•˜ìœ„í˜¸í™˜ ìŠ¬ë¡¯

      return { day, title, ref, url, naver, tistory };
    })
    .filter(e=>e.day>=1 && e.day<=31);
}

// ì—°ê°„ í¬ë§·: "MM-DD|ì œëª©|ë³¸ë¬¸(ì„ íƒ)|ë„¤ì´ë²„/í‹°ìŠ¤í† ë¦¬ URL 2ê°œ" â†’ í•´ë‹¹ ì›”ë§Œ ì¶”ì¶œ
function parseYearly(text, month){
  const mm = String(month).padStart(2,'0');
  const host  = u => { try{ return new URL(u).host; }catch(_){ return ''; } };

  return text
    .replace(/^\uFEFF/, '')
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l && !l.startsWith('#') && l.startsWith(mm+'-'))
    .map(l=>{
      const parts = l.split('|').map(s=>(s||'').trim());
      const md  = parts[0]||'';
      const day = Number((md.split('-')[1]||'0'));

      const rest   = parts.slice(1);
      const isUrl  = (s)=>/^https?:\/\//i.test(s||'');
      const urls   = rest.filter(isUrl);
      const texty  = rest.filter(x=>!isUrl(x));

      const title  = texty[0] || '';
      const ref    = texty[1] || '';

      let naver='', tistory='';
      for (const u of urls){
        const h = host(u);
        if (h.includes('blog.naver.com')) naver   ||= u;
        if (h.includes('tistory.com'))    tistory ||= u;
      }
      const url = urls[0] || '';

      return { day, title, ref, url, naver, tistory };
    })
    .filter(e=>e.day>=1 && e.day<=31);
}

async function loadMonthData(year, month){
  const ym = `${year}-${String(month).padStart(2,'0')}`;
  const monthly = await tryFetch(`${DATA_DIR}/${ym}.txt`);
  if (monthly != null) {
    const parsed = parseMonthly(monthly);
    if (parsed.length) return parsed;  // ì›” íŒŒì¼ì´ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ì‚¬ìš©
  }
  const yearly = await tryFetch(`${DATA_DIR}/${year}.txt`);
  if (yearly != null) {
    const parsed = parseYearly(yearly, month);
    if (parsed.length) return parsed;  // ì—°ê°„ íŒŒì¼ì—ì„œ í•´ë‹¹ ì›”ë§Œ ì¶”ì¶œ
  }
  console.warn('No data parsed for', {year, month});
  return [];
}

/* ======================================
   URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ë Œë”ë§ ì „ì—)
   - ym=YYYY-MM ìš°ì„ 
   - y=YYYY ìˆì„ ë•ŒëŠ” ì›”ì€ ê¸°ë³¸ê°’/ì˜¤ëŠ˜
   - lang=ko|en|es|zh...
====================================== */
const usp     = new URLSearchParams(location.search);
const ymQP    = usp.get('ym');                 // "YYYY-MM"
const yQP     = usp.get('y');                  // "YYYY"
const lang    = usp.get('lang') || 'ko';

// âœ… ì¶”ê°€: m íŒŒë¼ë¯¸í„°(1~12)ë„ í—ˆìš©
const mQPraw  = usp.get('m');
const mQP     = mQPraw ? parseInt(mQPraw, 10) : NaN;  

let currentYear, currentMonth;                 // 1~12
(function decideInitialYM(){
 // 1) ym=YYYY-MM ì´ ì˜¤ë©´ ìµœìš°ì„   
  if (ymQP && /^\d{4}-\d{2}$/.test(ymQP)) {
    const [y, m] = ymQP.split('-').map(Number);
    currentYear  = y;
    currentMonth = m;
    return;
  }
  // 2) ì•„ë‹ˆë©´ y, m ë¶„ë¦¬ ì²˜ë¦¬ (ì—†ìœ¼ë©´ ê¸°ë³¸/ì˜¤ëŠ˜)
  const now = new Date();
  const fallbackY = (typeof DEFAULT_YEAR  !== 'undefined' ? DEFAULT_YEAR  : now.getFullYear());
  const fallbackM = (typeof DEFAULT_MONTH !== 'undefined' ? DEFAULT_MONTH : now.getMonth() + 1);
  // âœ… ì—¬ê¸°ì„œ m=10ì´ ì˜¤ë©´ ê·¸ê±¸ ìš°ì„ 
 currentYear  = (yQP && /^\d{4}$/.test(yQP)) ? Number(yQP) : fallbackY;
  currentMonth = (!Number.isNaN(mQP) && mQP >= 1 && mQP <= 12) ? mQP : fallbackM;
})();

// ì›” ì´ë™ ìœ í‹¸ / ë§í¬ ìƒì„±
function shiftMonth(y, m, delta){
  const d = new Date(y, m - 1 + delta, 1);
  return { y: d.getFullYear(), m: d.getMonth() + 1 };
}
function mm(n){ return String(n).padStart(2,'0'); }
function monthUrl(y, m){
  const base = location.pathname.split('/').pop() || 'index.html';
  // href í´ë°±ìš©(ë¹„JS í™˜ê²½) + ì£¼ì†Œ í‘œì‹œ ê°±ì‹ ìš©
  return `${base}?lang=${encodeURIComponent(lang)}&y=${y}&ym=${y}-${mm(m)}`;
}

// ì„ íƒ: ì™¸ë¶€ ì ‘ê·¼ ì»¨í…ìŠ¤íŠ¸
window.calendarContext = {
  year:  currentYear,
  month: currentMonth,
  ym:    `${currentYear}-${mm(currentMonth)}`,
  lang
};

/* ======================================
   ì—°ê°„ ë°ì´í„° í”„ë¦¬ë¡œë“œ & ìºì‹œ
   - ìµœì´ˆ 1íšŒ ì—°ê°„ íŒŒì¼ ë¡œë“œ
   - í•´ë‹¹ ì›”ë³„ íŒŒì¼ì´ ìˆìœ¼ë©´ ê·¸ ë‹¬ë§Œ ë®ì–´ì“°ê¸° (ì›”ë³„ > ì—°ê°„)
====================================== */
const yearCache = new Map(); // year -> { byMonth: Map(1..12 -> items[]) }

async function preloadYear(year){
  if (yearCache.has(year)) return yearCache.get(year);

  // 1) ì—°ê°„ íŒŒì¼
  const yearlyText = await tryFetch(`${DATA_DIR}/${year}.txt`);
  const byMonth = new Map();
  if (yearlyText){
    for (let m=1; m<=12; m++){
      byMonth.set(m, parseYearly(yearlyText, m)); // ë¹„ì–´ìˆìœ¼ë©´ []
    }
  } else {
    for (let m=1; m<=12; m++) byMonth.set(m, []);
  }

  // 2) ì›”ë³„ íŒŒì¼ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‹¬ë§Œ ë®ì–´ì“°ê¸°
  const checks = [];
  for (let m=1; m<=12; m++){
    const ym = `${year}-${mm(m)}`;
    checks.push(
      tryFetch(`${DATA_DIR}/${ym}.txt`).then(txt=>{
        if (txt){
          const parsed = parseMonthly(txt);
          if (parsed && parsed.length) byMonth.set(m, parsed);
        }
      })
    );
  }
  await Promise.all(checks);

  const payload = { byMonth };
  yearCache.set(year, payload);
  return payload;
}

function getMonthItemsFromCache(year, month){
  const y = yearCache.get(year);
  if (!y) return [];
  return y.byMonth.get(month) || [];
}

/* ======================================
   ì›”ë°” UI (ë‚´ë¶€ ì „í™˜)
   - #m ì»¨í…Œì´ë„ˆì— 1~12 ë²„íŠ¼ ìƒì„±
   - í´ë¦­ ì‹œ ìƒˆë¡œê³ ì¹¨ ì—†ì´ setMonthë¡œ ì „í™˜
====================================== */
function buildMonthBar(year, month){
  const cont = qs('#m');
  if (!cont) return;

  // 1) 1~12ì›” ë²„íŠ¼ ë Œë” (hrefëŠ” í´ë°±, í´ë¦­ì€ ë‚´ë¶€ ì „í™˜)
  const parts = [];
  for (let m=1; m<=12; m++){
    const active = (m===month) ? ' aria-current="true" class="active"' : '';
    parts.push(
      `<a href="${monthUrl(year,m)}" data-y="${year}" data-m="${m}"${active}>${mm(m)}</a>`
    );
  }
  cont.innerHTML = parts.join('');

  // 2) í´ë¦­ ì‹œ ë‚´ë¶€ ì „í™˜
  if (!cont.dataset.bound){
    cont.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-y][data-m]');
      if (!a) return;
      e.preventDefault();
      const y = Number(a.getAttribute('data-y'));
      const m = Number(a.getAttribute('data-m'));
      setMonth(y, m); // ë‚´ë¶€ ì¬ë Œë”
    });
    cont.dataset.bound = '1';
  }
}

/* ======================================
   ì›” ì „í™˜(ë‚´ë¶€ ë Œë”ë§Œ)
   - ìƒˆë¡œê³ ì¹¨ ì—†ì´ í—¤ë”/ì›”ë°”/ë³¸ë¬¸/í”Œë ˆì´ì–´ ê°±ì‹ 
   - prev/nextë„ ë‚´ë¶€ ì „í™˜ìœ¼ë¡œ ì—°ê²°
====================================== */
async function setMonth(year, month, {pushState=true} = {}){
  // ë²”ìœ„ ë³´ì •
  if (month < 1){ year--; month = 12; }
  if (month > 12){ year++; month = 1; }

  // ì»¨í…ìŠ¤íŠ¸ ê°±ì‹ 
  currentYear  = year;
  currentMonth = month;
  window.calendarContext = {
    ...window.calendarContext,
    year, month, ym: `${year}-${mm(month)}`
  };

  // ì—°ê°„ ìºì‹œ ì¤€ë¹„
  await preloadYear(year);

  // í—¤ë”/ì›”ë°”/ë³¸ë¬¸ ë Œë” (ë Œë” í•¨ìˆ˜ëŠ” ì•„ë˜ ì„¹ì…˜ì—ì„œ ì •ì˜ë¨)
  if (typeof setYearLabel === 'function') setYearLabel(year);
  buildMonthBar(year, month);

  const items = getMonthItemsFromCache(year, month);
  if (typeof renderCalendar === 'function'){
    renderCalendar(year, month, items); // â† ë„¤ ë Œë” í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì— ë§ì¶¤
  }

  // ì°¬ì–‘ í”Œë ˆì´ì–´ ì„¸íŒ…
  setupHymnPlayer(year, month);

  // prev/next ë²„íŠ¼(ìˆë‹¤ë©´) ë™ì‘
  const prevA = document.querySelector('a#prev');
  const nextA = document.querySelector('a#next');
  const p = shiftMonth(year, month, -1);
  const n = shiftMonth(year, month, +1);

  if (prevA) {
    prevA.href = monthUrl(p.y, p.m);
    prevA.onclick = (e)=>{ e.preventDefault(); setMonth(p.y, p.m); };
  }
  if (nextA) {
    nextA.href = monthUrl(n.y, n.m);
    nextA.onclick = (e)=>{ e.preventDefault(); setMonth(n.y, n.m); };
  }

  // ì£¼ì†Œ í‘œì‹œë§Œ ê°±ì‹  (ìƒˆë¡œê³ ì¹¨ ì—†ìŒ, ë¸”ë¡œê·¸ ì„ë² ë“œì—ì„œë„ OK)
  if (pushState){
    const base = location.pathname.split('/').pop() || 'index.html';
    const url  = `${base}?lang=${encodeURIComponent(lang)}&y=${year}&ym=${year}-${mm(month)}`;
    history.replaceState({year, month}, '', url);
  }
}

/* ======================================
   ì´ˆê¸° êµ¬ë™
   - ì—°ê°„ ë°ì´í„° ìºì‹œ â†’ ìµœì´ˆ ë‹¬ ë Œë”
====================================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await preloadYear(currentYear);
  await setMonth(currentYear, currentMonth, {pushState:false});
});

  /* ===== ë Œë”ë§ ===== */
  function setYearLabel(year){
    const y = qs('#year-label');
    if(y) y.textContent = `${year}ë…„`;
  }
  function buildMonthBar(year, month){
    const mb = qs('#monthbar');
    if(!mb) return;
    mb.innerHTML = '';
    for(let m=1;m<=12;m++){
      const a = document.createElement('a');
      a.href = '#';
      a.textContent = `${m}ì›”`;
      if(m===month) a.classList.add('active');
      a.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const url = new URL(location.href);
        url.searchParams.set('y', String(year));
        url.searchParams.set('m', String(m));
        const src = new URL(location.href).searchParams.get('src');
        if (src) url.searchParams.set('src', src); // â† src ìœ ì§€
        history.pushState({},'',url);
        render(year,m);
      });
      mb.appendChild(a);
    }
  }
  function monthMeta(year, month){
    const first = new Date(year, month-1, 1);
    const last  = new Date(year, month, 0);
    return { startWeekday: first.getDay(), totalDays: last.getDate() };
  }

function makeDayCellHTML(dayNum, entry){
  const pref = getSourcePref(); // 'naver' | 'tistory' | ''
  let primary =
    (pref === 'naver'   && entry?.naver)   ? entry.naver :
    (pref === 'tistory' && entry?.tistory) ? entry.tistory :
    (entry?.tistory || entry?.naver || entry?.url || '');

  const titleText = entry?.title || (primary ? 'ì—´ê¸°' : '');
  const refHTML   = entry?.ref ? `<div class="ref">${entry.ref}</div>` : '';
  const titleHTML = primary
    ? `<a class="mainlink" href="${primary}" target="_blank" rel="noopener">${titleText}</a>`
    : `${titleText}`;

  const inner = `
    <div class="title" style="padding:8px 10px 2px; font-size:13px;">${titleHTML}</div>
    ${refHTML}
  `;

  return `
    <td>
      <span class="daynum">${dayNum}</span>
      <div class="box">${inner}</div>
    </td>
  `;
}

  function buildTableBody(year, month, entries){
    const { startWeekday, totalDays } = monthMeta(year, month);
    const byDay = new Map(entries.map(e=>[e.day, e]));
    let html = '', day = 1;
    for(let row=0; row<6; row++){
      html += '<tr>';
      for(let col=0; col<7; col++){
        const idx = row*7 + col;
        if(idx < startWeekday || day > totalDays){
          html += '<td></td>';
        }else{
          html += makeDayCellHTML(day, byDay.get(day));
          day++;
        }
      }
      html += '</tr>';
    }
    return html;
  }

  /* ===== ì‹œì‘ & ë’¤/ì• ì´ë™ ===== */
  window.addEventListener('DOMContentLoaded', ()=>{
    const { y, m } = getYMFromURL();
    render(y, m);
  });
  window.addEventListener('popstate', ()=>{
    const { y, m } = getYMFromURL();
    render(y, m);
  });

async function render(year, month){
  setYearLabel(year);
  buildMonthBar(year, month);

  const brand = document.getElementById('brand-link');
  if (brand){
    const u = new URL(location.href);
    u.searchParams.set('y', String(year));
    u.searchParams.set('m', String(month));
    brand.href = u.pathname + u.search;
  }

  const tbody = document.querySelector('#tbody');
  if(tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:20px; text-align:center; color:var(--muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>`;

  const entries = await loadMonthData(year, month);

  // âœ… ë¹ˆ ë°ì´í„°ì¼ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ í›„ ì¢…ë£Œ(return)í•´ì•¼ í•¨
  if (!entries.length && tbody){
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="padding:20px; text-align:center; color:var(--muted)">
          ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. <code>${DATA_DIR}/${year}-${String(month).padStart(2,'0')}.txt</code> ë˜ëŠ”
          <code>${DATA_DIR}/${year}.txt</code>ë¥¼ í™•ì¸í•˜ì„¸ìš”.
        </td>
      </tr>`;
    setupHymnPlayer(year, month);
    return; // â¬…ï¸ ì¤‘ìš”!
  }

  // âœ… ë°ì´í„°ê°€ ìˆìœ¼ë©´ í…Œì´ë¸”ì„ ê·¸ë¦¬ê³  ì°¬ì–‘ í”Œë ˆì´ì–´ ì„¸íŒ…
  if(tbody) tbody.innerHTML = buildTableBody(year, month, entries);
  setupHymnPlayer(year, month);
}  // â¬…ï¸ render í•¨ìˆ˜ ë‹«í˜
  </script>
</body>
</html>
