<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
    --accent:#0ea5e9; --accent-weak:#e0f2fe; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#e5e7eb; --muted:#9ca3af; --line:#26303a; --line-strong:#334155;
      --accent:#38bdf8; --accent-weak:#0b2a3a; --bg:#0b0f14; --bgsoft:#0f1720; --box:#0f1720;
    }
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
  }
  .wrap{max-width:1080px;margin:0 auto;padding:24px 16px;}

  /* 상단 */
  .top{display:grid;grid-template-rows:48px 40px 40px;row-gap:12px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:22px;}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);}
  .yearbar{display:flex;justify-content:center;align-items:center;gap:16px;}
  .yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg);}
  .yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg);}
  .monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px;}
  .monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box);}
  .monthbar a.active{border-color:var(--accent);outline:2px solid var(--accent-weak);}

  /* 달력 */
  .cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box);}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft);}
  .cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{
    border-right:1px solid var(--line);border-bottom:1px solid var(--line);
    padding:10px; display:flex;
  }
  .grid .cell:nth-child(7n){border-right:none;}
  .grid .cell.is-empty{background:linear-gradient(180deg, rgba(0,0,0,0.02) 0 0) top/100% 44px no-repeat;}

  /* ✅ 셀 전체 둥근 네모칸 (링크/디브 모두 공통) */
  .cellbox{
    display:flex; flex-direction:column; gap:8px;
    width:100%; min-height:120px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:linear-gradient(180deg, rgba(0,0,0,0.03) 0 44px, transparent 44px);
    text-decoration:none; color:inherit;
    transition:transform .05s ease, box-shadow .15s ease, border-color .15s ease;
  }
  /* 링크형 셀 호버효과 */
  a.cellbox:hover{ box-shadow:0 2px 10px rgba(0,0,0,.06); border-color:var(--accent); }
  a.cellbox:active{ transform:translateY(1px); }

  .dnum{
    font-size:12px;color:var(--muted);
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:2px;
  }

  /* 제목칸: 이제 셀 내부 요소로 (셀 전체 둥근칸과 조화) */
  .slot-title{
    display:flex;align-items:center;
    min-height:2.2em;
    padding:6px 8px;
    border-radius:8px;
    background:rgba(14,165,233,0.08);
    border:1px solid var(--line);
    font-size:14px; line-height:1.25;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .slot-title.empty{ background:rgba(0,0,0,0.03); }
  .slot-title a{ color:inherit; text-decoration:none; }
  .slot-title a:hover{ text-decoration:underline; }

  .ref{
    font-size:12px;color:var(--muted);
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .more{font-size:11px;color:var(--muted);}

  @media (prefers-color-scheme: dark){
    .cellbox{
      background:linear-gradient(180deg, rgba(255,255,255,0.04) 0 44px, transparent 44px);
    }
    .slot-title{ background:rgba(56,189,248,0.10); }
    .slot-title.empty{ background:rgba(255,255,255,0.05); }
  }
  @media (max-width:640px){
    .cellbox{min-height:110px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <section class="top" aria-label="상단">
      <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
      <nav class="yearbar" aria-label="년도">
        <a id="prevYear" href="#">◀</a>
        <span class="yr" id="yearLabel">2025</span>
        <a id="nextYear" href="#">▶</a>
      </nav>
      <nav class="monthbar" id="monthbar" aria-label="월"></nav>
    </section>

    <section class="cal" aria-label="달력">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

  <script>
  (function(){
    /* URL 파라미터 견고 파서 */
    var qs = location.search || "";
    function pickLastNum(keyFallback, fallback){
      var u = new URL(location.href);
      var v = u.searchParams.get(keyFallback);
      var re = new RegExp("(?:\\b"+keyFallback+"\\b|\\byear\\b|\\bmonth\\b|\\bm\\b|\\by\\b)\\s*=\\s*(\\d{1,4})","gi");
      var mm, last=null;
      while((mm = re.exec(qs))){ last = mm[1]; }
      var cand = (last!==null)? last : v;
      var n = parseInt(cand,10);
      return (isFinite(n)? n : fallback);
    }
    var today = new Date();
    var y = pickLastNum('y', today.getFullYear());
    if(!(y>=1900 && y<=9999)) y = today.getFullYear();
    var m = pickLastNum('m', (today.getMonth()+1));
    if(!(m>=1 && m<=12)) m = today.getMonth()+1;

    function makeUrl(nextY, nextM){
      var u = new URL(location.href);
      u.searchParams.set('y', String(nextY));
      u.searchParams.set('m', String(nextM));
      return u.pathname + u.search;
    }

    document.getElementById('yearLabel').textContent = y;
    document.getElementById('prevYear').href = makeUrl(y-1, m);
    document.getElementById('nextYear').href = makeUrl(y+1, m);

    (function buildMonthbar(){
      var box = document.getElementById('monthbar'); box.innerHTML='';
      for(var i=1;i<=12;i++){
        var a = document.createElement('a');
        a.textContent = i+'월';
        a.href = makeUrl(y, i);
        if(i===m) a.className='active';
        box.appendChild(a);
      }
    })();

    /* 데이터 로딩 */
    var ym = y + '-' + String(m).padStart(2,'0') + '.txt';
    var basePath = location.pathname.replace(/[^\/]*$/, '');
    var candidates = [ basePath + 'data/' + ym, '/data/' + ym ];

    var dayMap = Object.create(null);

    function parseText(text){
      if(text && text.charCodeAt && text.charCodeAt(0)===0xFEFF) text = text.slice(1);
      var lines = (text||'').replace(/\r\n?/g,'\n').split('\n');
      for(var i=0;i<lines.length;i++){
        var line = lines[i].trim(); if(!line) continue;
        var parts = line.split('|'); if(parts.length<2) continue;
        var dd = parseInt((parts[0]||'').trim(),10);
        if(!(dd>=1 && dd<=31)) continue;
        var title = (parts[1]||'').trim();
        var ref   = (parts[2]||'').trim();
        var url   = (parts[3]||'').trim();
        if(!dayMap[dd]) dayMap[dd] = {title:title, ref:ref, url:url, extraCount:0};
        else dayMap[dd].extraCount++;
      }
    }

    function tryFetch(i){
      if(i>=candidates.length){ render(); return; }
      fetch(candidates[i], {cache:'no-store'})
        .then(function(r){ return r.ok ? r.text() : ''; })
        .then(function(t){ if(t && t.trim().length){ parseText(t); render(); } else tryFetch(i+1); })
        .catch(function(){ tryFetch(i+1); });
    }
    tryFetch(0);

    /* 렌더: URL 있으면 셀 전체를 <a class="cellbox">로 */
    function render(){
      var grid = document.getElementById('grid'); grid.innerHTML='';
      var first = new Date(y, m-1, 1);
      var start = first.getDay();
      var days = new Date(y, m, 0).getDate();

      var cells = [];
      for(var i=0;i<start;i++) cells.push({empty:true});
      for(var d=1; d<=days; d++) cells.push({empty:false, day:d, info:dayMap[d]});
      while(cells.length%7!==0) cells.push({empty:true});

      for(var k=0;k<cells.length;k++){
        var c = cells[k];
        var cell = document.createElement('div');
        cell.className = 'cell' + (c.empty?' is-empty':'');
        if(c.empty){ grid.appendChild(cell); continue; }

        var info = c.info;
        var box;
        if(info && info.url){
          box = document.createElement('a');
          box.href = info.url; box.target = '_blank'; box.rel='noopener';
          box.className = 'cellbox';
        }else{
          box = document.createElement('div');
          box.className = 'cellbox';
        }

        var dline = document.createElement('div'); dline.className='dnum';
        dline.innerHTML = '<span>'+c.day+'</span>';
        box.appendChild(dline);

        var titleEl = document.createElement('div');
        titleEl.className = 'slot-title';
        if(info && info.title){
          titleEl.textContent = info.title;
        }else{
          titleEl.classList.add('empty');
          titleEl.textContent = '';
        }
        box.appendChild(titleEl);

        if(info && info.ref){
          var r = document.createElement('div'); r.className='ref';
          r.textContent = info.ref; box.appendChild(r);
        }
        if(info && info.extraCount>0){
          var mline = document.createElement('div'); mline.className='more';
          mline.textContent = '+'+ info.extraCount +' 더 있음'; box.appendChild(mline);
        }

        cell.appendChild(box);
        grid.appendChild(cell);
      }
    }
  })();
  </script>
</body>
</html>
