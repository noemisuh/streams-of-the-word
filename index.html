<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{--fg:#111827;--muted:#6b7280;--line:#e5e7eb;--line-strong:#cbd5e1;--accent:#0ea5e9;--bg:#ffffff;--box:#ffffff;--bgsoft:#f8fafc}
@media (prefers-color-scheme: dark){
  :root{--fg:#e5e7eb;--muted:#9ca3af;--line:#334155;--line-strong:#475569;--accent:#38bdf8;--bg:#0b0f14;--box:#0f1720;--bgsoft:#0f1720}
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif}
a{color:#0ea5e9}
.wrap{max-width:1080px;margin:0 auto;padding:56px 16px 24px}
.top{display:grid;grid-template-rows:40px 36px 40px;row-gap:12px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:18px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
.yearbar{display:flex;justify-content:center;align-items:center;gap:16px}
.yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg)}
.yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg)}
.monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px}
.monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box)}
.monthbar a.active{border-color:var(--accent);outline:2px solid rgba(56,189,248,.25)}
.cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box)}
.cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft)}
.cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(7,1fr)}
.cell{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px;position:relative}
.grid .cell:nth-child(7n){border-right:none}
.cellbox{position:relative;display:flex;flex-direction:column;width:100%;min-height:140px;padding:28px 16px 16px;border:1px solid var(--line);border-radius:14px;background:rgba(14,165,233,.10);text-decoration:none;color:inherit;transition:box-shadow .15s,border-color .15s,background .15s}
a.cellbox:hover{box-shadow:0 2px 10px rgba(0,0,0,.06);border-color:var(--accent);background:rgba(14,165,233,.14)}
.dnum-badge{position:absolute;left:10px;top:10px;z-index:3;font-size:12px;color:var(--muted);padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:var(--box)}
.center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:6px 4px}
.title-center{max-width:100%;font-size:16px;line-height:1.4;white-space:normal;word-break:keep-all;text-wrap:balance;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;margin:0}
.ref{margin-top:8px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
@media (prefers-color-scheme: dark){
  .cellbox{background:rgba(56,189,248,.12)}
  .dnum-badge{background:#0f1720;border-color:#334155;color:#9ca3af}
}

/* ===== 상단 네비: 단일 다크 스타일 최종본 ===== */
.site-nav{background:#0f172a;color:#fff;position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(255,255,255,.08)}
.site-nav nav{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;padding:12px}
.site-nav a{color:#fff;text-decoration:none;opacity:.9;padding:4px 6px;border-radius:8px}
.site-nav a:hover,.site-nav a:focus{opacity:1;text-decoration:underline}
.site-nav a[aria-current="page"]{opacity:1;background:rgba(255,255,255,.12)}
.site-nav .sep{margin:0 6px;opacity:.35}
.site-nav small{opacity:.8;font-size:.9em}
.site-nav .group .label{font-weight:600;margin-right:4px}
.site-nav .inline-links{font-size:.95em;opacity:.85}

h1#page-title,h1.page-title{display:none!important}
.topbar,.header,#title-wrap{overflow:visible!important;height:auto!important}
</style>
</head>
<body>
  
<header class="site-nav" role="navigation" aria-label="사이트 공통 메뉴">
  <nav>
    <a href="https://noemisuh.github.io/faith-scripture/">믿음으로 쓰는 성경</a>
    <span class="sep" aria-hidden="true">|</span>

    <a href="https://noemisuh.github.io/faith-bible-copy/">필사 성경</a>
    <span class="sep" aria-hidden="true">|</span>

    <!-- 말씀따라 흐르는 샘물 (언어 묶음) -->
    <span class="group">
      <a class="label" href="https://noemisuh.github.io/streams-of-the-word/">말씀따라 흐르는 샘물</a>
      <small class="inline-links" aria-label="Streams of the Word languages">
        ( <a href="https://noemisuh.github.io/streams-of-the-word/?lang=ko">한국어</a>
        <span class="sep">ㅣ</span>
        <a href="https://noemisuh.github.io/streams-of-the-word/?lang=en">English</a>
        <span class="sep">ㅣ</span>
        <a href="https://noemisuh.github.io/streams-of-the-word/?lang=es">Español</a>
        <span class="sep">ㅣ</span>
        <a href="https://noemisuh.github.io/streams-of-the-word/?lang=zh">中文</a> )
      </small>
    </span>

    <span class="sep" aria-hidden="true">|</span>

    <!-- 블로그 (네이버 ㅣ 티스토리) -->
    <span class="group">
      <span class="label">블로그</span>
      <small class="inline-links" aria-label="Blogs">
        ( <a href="https://blog.naver.com/noemisuh" target="_blank" rel="noopener">네이버</a>
        <span class="sep">ㅣ</span>
        <a href="https://noemisuh.tistory.com" target="_blank" rel="noopener">티스토리</a> )
      </small>
    </span>
  </nav>
</header>

<div class="wrap">
  <header id="title-wrap"><h1 id="page-title" class="page-title"></h1></header>
  <section class="top" aria-label="상단">
    <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
    <nav class="yearbar" aria-label="년도">
      <a id="prevYear" href="#" aria-label="이전 해">◀</a>
      <span class="yr" id="yearLabel">0000</span>
      <a id="nextYear" href="#" aria-label="다음 해">▶</a>
    </nav>
    <nav class="monthbar" id="monthbar" aria-label="월"></nav>
  </section>

  <section class="cal" aria-label="달력">
    <div class="head" id="weekday-head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
    <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
  </section>
</div>

<script>
(function(){
  /* ===== I18N ===== */
  var I18N = {
  ko: {
    brand: "말씀따라 흐르는 샘물",
    daysShort: ["일","월","화","수","목","금","토"],
    monthsShort:["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"],
    monthsFull: ["1","2","3","4","5","6","7","8","9","10","11","12"],
    nav: { root:"믿음으로 쓰는 성경", copy:"필사 성경", streams:"말씀따라 흐르는 샘물", blog:"블로그" },
    title: (y,m)=> `${y}년 ${m}월`
  },
  es: {
    brand: "Riachuelos de la Palabra",
    daysShort: ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"],
    monthsShort:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
    monthsFull: ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],
    nav: { root:"Biblia por fe", copy:"Biblia copiada a mano", streams:"Riachuelos de la Palabra", blog:"Blog" },
    title: (y,mname)=> `${mname} de ${y}`
  },
  en: {
    brand: "Streams of the Word",
    daysShort: ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],
    monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    monthsFull: ["January","February","March","April","May","June","July","August","September","October","November","December"],
    nav: { root:"Faith Scripture", copy:"Hand-copied Bible", streams:"Streams of the Word", blog:"Blog" },
    title: (y,mname)=> `${mname} ${y}`
  },
  zh: {
    brand: "话语之溪流",
    daysShort: ["日","一","二","三","四","五","六"],
    monthsShort:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],
    monthsFull: ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],
    nav: { root:"凭信写圣经", copy:"手抄圣经", streams:"话语之溪流", blog:"博客" },
    title: (y,mname)=> `${y}年${mname}`
  }
};

  /* ===== 파라미터/언어 ===== */
  var now=new Date();
  var u=new URL(location.href);
  var qLang=(u.searchParams.get('lang')||'').toLowerCase();
  var saved=localStorage.getItem('sow_lang')||'';
  var lang=qLang||saved||'ko'; if(!I18N[lang]) lang='ko';
  try{localStorage.setItem('sow_lang',lang);}catch(e){}
  document.documentElement.setAttribute('lang',lang);
  var I=I18N[lang];

  var hash=(location.hash||'').replace('#','').trim(); // YYYY-MM
  var hashYm=hash.match(/^(\d{4})-(0[1-9]|1[0-2])$/);
  var y=parseInt(u.searchParams.get('y')||(hashYm?hashYm[1]:now.getFullYear()),10);
  var m=parseInt(u.searchParams.get('m')||(hashYm?hashYm[2]:(now.getMonth()+1)),10);
  if(!(y>=1900&&y<=9999)) y=now.getFullYear();
  if(!(m>=1&&m<=12)) m=now.getMonth()+1;

  /* ===== 상단 UI ===== */
  var yLabel=document.getElementById('yearLabel'); if(yLabel) yLabel.textContent=y;
  var prev=document.getElementById('prevYear'); var next=document.getElementById('nextYear');
  if(prev) prev.onclick=function(e){e.preventDefault();go(y-1,m)}; if(next) next.onclick=function(e){e.preventDefault();go(y+1,m)};
  var brandText=document.querySelector('.brand span:last-child'); if(brandText) brandText.textContent=I.brand;

  function go(y2,m2){
    var nu=new URL(location.href);
    nu.searchParams.set('y',String(y2)); nu.searchParams.set('m',String(m2));
    nu.searchParams.set('lang',lang); nu.searchParams.set('v',Date.now());
    location.href=nu.toString();
  }

  // 요일 헤더
  var head=document.getElementById('weekday-head'); if(head){ head.innerHTML=''; I.daysShort.forEach(function(d){var dv=document.createElement('div'); dv.textContent=d; head.appendChild(dv);});}

  // 월바
  var mbar=document.getElementById('monthbar');
  if(mbar){
    mbar.innerHTML='';
    for(var i=1;i<=12;i++){
      (function(ii){
        var a=document.createElement('a'); a.href='#'; a.textContent=I.monthsShort[ii-1];
        if(ii===m) a.className='active';
        a.onclick=function(e){e.preventDefault();go(y,ii)};
        mbar.appendChild(a);
      })(i);
    }
  }

  // 문서 제목
  function setPageTitle(yy,mmNum){
    var nice=(lang==='es'||lang==='en'||lang==='zh') ? I.title(yy, I.monthsFull[mmNum-1]) : I.title(yy, mmNum);
    document.title=I.brand+' - '+nice;
  }

  /* ===== 단일파일 내장 데이터 사용 =====
     window.SOW_EMBED_DATA = {
       "2025-11:ko": [
          ["01","감사로 시작하라","시편 100:4","https://..."],
          ...
       ],
       "2025-11:es": [ ... ]
     }
  */
  var key = (y+'-'+String(m).padStart(2,'0')+':'+lang);
  var dayMap = Object.create(null);
  var data = (window.SOW_EMBED_DATA && window.SOW_EMBED_DATA[key]) || [];

  data.forEach(function(row){
    var d = parseInt(row[0],10);
    if(!(d>=1&&d<=31)) return;
    dayMap[d] = { title: row[1]||'', ref: row[2]||'', href: row[3]||'' };
  });

  function render(){
    var grid=document.getElementById('grid'); if(!grid) return;
    grid.innerHTML='';
    var first=new Date(y,m-1,1); var start=first.getDay(); var days=new Date(y,m,0).getDate();
    var cells=[];
    for(var s=0;s<start;s++) cells.push({empty:true});
    for(var d=1; d<=days; d++) cells.push({empty:false,d:d,info:dayMap[d]});
    while(cells.length%7!==0) cells.push({empty:true});

    cells.forEach(function(c){
      var cell=document.createElement('div'); cell.className='cell';
      if(c.empty){grid.appendChild(cell);return;}
      var info=c.info;
      var el = (info && info.href) ? document.createElement('a') : document.createElement('div');
      el.className='cellbox';
      if(info && info.href){ el.href=info.href; el.target='_blank'; el.rel='noopener'; }

      var badge=document.createElement('div'); badge.className='dnum-badge'; badge.textContent=c.d; el.appendChild(badge);
      var center=document.createElement('div'); center.className='center';
      var tEl=document.createElement('div'); tEl.className='title-center'; tEl.textContent=(info && info.title)||''; center.appendChild(tEl);
      if(info && info.ref){ var r=document.createElement('div'); r.className='ref'; r.textContent=info.ref; center.appendChild(r); }
      el.appendChild(center);
      cell.appendChild(el); grid.appendChild(cell);
    });

    setPageTitle(y,m);
  }

  // 렌더
  render();
})();
</script>

<script>
/* JSON 블록을 window.SOW_EMBED_DATA로 로드 */
(function(){
  try{
    var raw=document.getElementById('SOW_EMBED_DATA')?.textContent?.trim() || '';
    window.SOW_EMBED_DATA = raw ? JSON.parse(raw) : {};
  }catch(e){
    window.SOW_EMBED_DATA={};
    console.error('내장 데이터 파싱 오류:', e);
  }
})();
</script>

<script>
(function(){
  // URL에서 y,m,lang 추출 (없으면 현재 달/ko)
  var u = new URL(location.href);
  var now = new Date();
  var y = parseInt(u.searchParams.get('y') || now.getFullYear(), 10);
  var m = parseInt(u.searchParams.get('m') || (now.getMonth()+1), 10);
  var lang = (u.searchParams.get('lang') || localStorage.getItem('sow_lang') || 'ko').toLowerCase();
  if(!/^(ko|es|en|zh)$/.test(lang)) lang='ko';
  var mm = String(m).padStart(2,'0');

  var dayMap = Object.create(null);

  // 관대한 TXT 파서: 빈칸/||/공백/필드 수 유연 처리
  function parseText(t){
    if(!t) return;
    if(t.charCodeAt && t.charCodeAt(0)===0xFEFF) t = t.slice(1);
    t.replace(/\r\n?/g,'\n').split('\n').forEach(function(line){
      if(!line || /^\s*$/.test(line)) return;
      if(/^\s*#/.test(line)) return;
      var parts = line.split('|').map(function(s){ return (s||'').trim(); });
      if(parts.length < 2) return;
      var d = parseInt((parts[0]||'').replace(/^0+/,'')||parts[0],10);
      if(!(d>=1 && d<=31)) return;
      var title = parts[1]||'';
      var ref   = (parts.length>=3 ? parts[2] : '');
      var href  = '';
      for(var i=3;i<parts.length;i++){ if(parts[i]){ href = parts[i]; break; } }
      dayMap[d] = {title:title, ref:ref, href:href};
    });
  }

  // JSON 파서: {"YYYY-MM:ko":[["DD","제목","ref","링크1",...],...]}
  function parseJson(txt){
    if(!txt) return false;
    try{
      if(txt.charCodeAt && txt.charCodeAt(0)===0xFEFF) txt = txt.slice(1);
      var obj = JSON.parse(txt);
      var key = y + '-' + mm + ':' + lang;
      var arr = obj[key];
      if(!Array.isArray(arr)) return false;
      arr.forEach(function(row){
        var d = parseInt((row[0]||'').replace(/^0+/,'')||row[0],10);
        if(!(d>=1 && d<=31)) return;
        var title = row[1]||'';
        var ref   = row[2]||'';
        var href  = '';
        for(var i=3;i<row.length;i++){ if(row[i]){ href = row[i]; break; } }
        dayMap[d] = {title:title, ref:ref, href:href};
      });
      return true;
    }catch(e){ return false; }
  }

  function tryFetch(url){
    return fetch(url + '?v=' + Date.now(), {cache:'no-store'})
      .then(function(r){ return r.ok ? r.text() : ''; })
      .catch(function(){ return ''; });
  }

  // 언어TXT → koTXT → 기본TXT → JSON 순으로 시도
  function loadDataThenFill(){
    var cands = [
      'data/'+y+'-'+mm+'.'+lang+'.txt',
      'data/'+y+'-'+mm+'.ko.txt',
      'data/'+y+'-'+mm+'.txt',
      'data/'+y+'-'+mm+'.json'
    ];
    (function next(i){
      if(i>=cands.length){ fillIntoGrid(); return; }
      var url = cands[i];
      tryFetch(url).then(function(text){
        if(!text){ next(i+1); return; }
        if(/\.json(\?|$)/.test(url)){
          if(!parseJson(text)){ next(i+1); return; }
        }else{
          parseText(text);
        }
        fillIntoGrid(); // 첫 성공 시 바로 반영
      }).catch(function(){ next(i+1); });
    })(0);
  }

  // 이미 렌더된 그리드에 "비어있는 곳만" 제목/링크 주입
  function fillIntoGrid(){
    var grid = document.getElementById('grid');
    if(!grid) return;
    grid.querySelectorAll('.cell').forEach(function(cell){
      var badge = cell.querySelector('.dnum-badge');
      if(!badge) return;
      var d = parseInt(badge.textContent.trim(),10);
      var info = dayMap[d];
      if(!info || !info.title) return;

      var box = cell.querySelector('.cellbox');
      var center = box && box.querySelector('.center');
      var titleEl = center && center.querySelector('.title-center');
      var refEl = center && center.querySelector('.ref');

      // 제목이 비어있거나 기존 제목이 없을 때만 덮어쓰기
      if(titleEl && (!titleEl.textContent || /^\s*$/.test(titleEl.textContent))){
        titleEl.textContent = info.title || '';
      }
      if(info.ref){
        if(refEl){ refEl.textContent = info.ref; }
        else if(center){
          var r = document.createElement('div');
          r.className = 'ref';
          r.textContent = info.ref;
          center.appendChild(r);
        }
      }
      if(info.href){
        if(box && box.tagName === 'DIV'){
          // DIV → 클릭 가능한 박스로 전환(접근성 포함)
          box.setAttribute('role','link');
          box.setAttribute('tabindex','0');
          box.onclick = function(){ window.open(info.href, '_blank', 'noopener'); };
          box.onkeydown = function(e){ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); box.click(); } };
        }else if(box && box.tagName === 'A'){
          box.href = info.href;
          box.target = '_blank';
          box.rel = 'noopener';
        }
      }
    });

    // 상단 H1에 사이트명+월 타이틀 합동 표기(보이면)
    var h1 = document.getElementById('page-title');
    if(h1 && !h1.textContent.trim()){
      var brandEl = document.querySelector('.brand span:last-child');
      var brand = brandEl ? brandEl.textContent.trim() : '말씀따라 흐르는 샘물';
      var monthName = (function(){
        var ko = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
        return (lang==='ko') ? ko[m-1] : m; // 간단 처리
      })();
      h1.textContent = brand + ' — ' + y + '년 ' + monthName;
      h1.style.display = 'block';
    }
  }

  // DOM이 그려진 뒤 실행(기존 렌더 완료 후 보강)
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(loadDataThenFill, 0);
  }else{
    document.addEventListener('DOMContentLoaded', loadDataThenFill);
  }
})();
</script>

</body>
</html>
