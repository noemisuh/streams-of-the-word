<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
    --accent:#0ea5e9; --accent-weak:#e0f2fe; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#e5e7eb; --muted:#9ca3af; --line:#26303a; --line-strong:#334155;
      --accent:#38bdf8; --accent-weak:#0b2a3a; --bg:#0b0f14; --bgsoft:#0f1720; --box:#0f1720;
    }
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
  }
  /* 위 여백 넉넉히(2칸) + 브랜드 크기 축소 */
  .wrap{max-width:1080px;margin:0 auto;padding:56px 16px 24px;}
  .top{display:grid;grid-template-rows:40px 36px 40px;row-gap:12px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:18px;}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);}
  .yearbar{display:flex;justify-content:center;align-items:center;gap:16px;}
  .yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg);}
  .yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg);}
  .monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px;}
  .monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box);}
  .monthbar a.active{border-color:var(--accent);outline:2px solid var(--accent-weak);}

  /* ===== 달력 ===== */
  .cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box);}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft);}
  .cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}

/* 셀 */
.cell{
  border-right:1px solid var(--line); border-bottom:1px solid var(--line);
  padding:10px; position:relative;
}
.grid .cell:nth-child(7n){border-right:none;}

/* ✅ 셀 전체 둥근칸: 중앙 영역(center)이 남은 공간을 가득 채움 */
.cellbox{
  position:relative;
  display:flex; flex-direction:column;
  width:100%; min-height:140px;          /* 빈칸/있는칸 최소 높이 동일 */
  padding:16px 14px 14px;
  border:1px solid var(--line);
  border-radius:14px;
  background:rgba(14,165,233,0.10);
  text-decoration:none; color:inherit;
  transition:box-shadow .15s ease, border-color .15s ease, background .15s ease;
}
a.cellbox:hover{ box-shadow:0 2px 10px rgba(0,0,0,.06); border-color:var(--accent); background:rgba(14,165,233,0.14); }

/* 날짜 배지: 좌상단 고정 (제목과 물리적 분리) */
.dnum-badge{
  position:absolute; left:10px; top:10px;
  font-size:12px; color:var(--muted);
  padding:2px 6px; border:1px solid var(--line); border-radius:8px;
  background:var(--box);
}

/* ✅ 중앙 영역: 남은 공간을 통째로 차지해 수직/수평 중앙 배치 */
.center{
  flex:1;                          /* 남은 공간 가득 */
  display:flex; flex-direction:column;
  align-items:center; justify-content:center; /* 수평/수직 중앙 */
  text-align:center;
  padding:8px 4px;                 /* 날짜 배지와 간격 확보 */
}

/* ✅ 제목: 멀티라인(최대 3줄), 가운데 정렬, 말줄임 */
.title-center{
  max-width:100%;
  font-size:16px; line-height:1.4;
  white-space:normal;              /* 줄바꿈 허용 */
  word-break:keep-all;             /* 한글 단어 자연스럽게 */
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:3;            /* 최대 3줄 */
  -webkit-box-orient:vertical;
  text-wrap:balance;               /* 줄 균형 (지원 브라우저에서) */
  margin:0;                        /* 상단에 달라붙지 않게 center가 정렬 담당 */
}

/* 본문/추가 정보: 제목 아래, 연한 톤 */
.ref{
  margin-top:8px;
  font-size:12px; color:var(--muted);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.more{ font-size:11px; color:var(--muted); margin-top:4px; }

@media (prefers-color-scheme: dark){
  .cellbox{ background:rgba(56,189,248,0.12); }
  .dnum-badge{ background:#0f1720; border-color:#334155; color:#9ca3af; }
}
</style>
</head>
<body>
  <div class="wrap">
    <section class="top" aria-label="상단">
      <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
      <nav class="yearbar" aria-label="년도">
        <a id="prevYear" href="#">◀</a>
        <span class="yr" id="yearLabel">2025</span>
        <a id="nextYear" href="#">▶</a>
      </nav>
      <nav class="monthbar" id="monthbar" aria-label="월"></nav>
    </section>

    <section class="cal" aria-label="달력">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

  <script>
  (function(){
    /* ===== URL 파라미터 견고 파서 ===== */
    var qs = location.search || "";
    function pickLastNum(keyFallback, fallback){
      var u = new URL(location.href);
      var v = u.searchParams.get(keyFallback);
      var re = new RegExp("(?:\\b"+keyFallback+"\\b|\\byear\\b|\\bmonth\\b|\\bm\\b|\\by\\b)\\s*=\\s*(\\d{1,4})","gi");
      var mm, last=null;
      while((mm = re.exec(qs))){ last = mm[1]; }
      var cand = (last!==null)? last : v;
      var n = parseInt(cand,10);
      return (isFinite(n)? n : fallback);
    }
    var today = new Date();
    var y = pickLastNum('y', today.getFullYear());
    if(!(y>=1900 && y<=9999)) y = today.getFullYear();
    var m = pickLastNum('m', (today.getMonth()+1));
    if(!(m>=1 && m<=12)) m = today.getMonth()+1;

    /* 절대 URL로 반환 → 년도 링크 확실히 동작 */
    function makeUrl(nextY, nextM){
      var u = new URL(location.href);
      u.searchParams.set('y', String(nextY));
      u.searchParams.set('m', String(nextM));
      return u.href;  // 전체 URL
    }

    document.getElementById('yearLabel').textContent = y;
    document.getElementById('prevYear').href = makeUrl(y-1, m);
    document.getElementById('nextYear').href = makeUrl(y+1, m);

    (function buildMonthbar(){
      var box = document.getElementById('monthbar'); box.innerHTML='';
      for(var i=1;i<=12;i++){
        var a = document.createElement('a');
        a.textContent = i+'월';
        a.href = makeUrl(y, i);
        if(i===m) a.className='active';
        box.appendChild(a);
      }
    })();

/* === [연/월 링크 설정 + 강제 이동 이벤트] 시작 === */

// 현재 URL을 유지하면서 y/m만 교체하는 함수
function makeUrl(nextY, nextM){
  const u = new URL(window.location.href);
  u.searchParams.set('y', String(nextY));
  u.searchParams.set('m', String(nextM));
  return u.toString(); // 절대 URL
}

// 연도 화살표 href 세팅
const prevA = document.getElementById('prevYear');
const nextA = document.getElementById('nextYear');
prevA.href = makeUrl(y-1, m);
nextA.href = makeUrl(y+1, m);

// ✅ 클릭 강제 이동 (일부 스크립트가 a클릭을 가로채는 문제 방지)
prevA.addEventListener('click', function(e){
  e.preventDefault();
  window.location.href = makeUrl(y-1, m);
});
nextA.addEventListener('click', function(e){
  e.preventDefault();
  window.location.href = makeUrl(y+1, m);
});

// 월 링크 만들기
(function buildMonthbar(){
  var box = document.getElementById('monthbar'); box.innerHTML='';
  for(var i=1;i<=12;i++){
    var a = document.createElement('a');
    a.textContent = i+'월';
    a.href = makeUrl(y, i);
    if(i===m) a.className='active';
    box.appendChild(a);
  }
})();

// (선택) 월 링크도 강제 이동
(function enforceMonthClicks(){
  document.querySelectorAll('#monthbar a').forEach(function(a){
    a.addEventListener('click', function(e){
      e.preventDefault();
      window.location.href = this.href;
    });
  });
})();

/* === [연/월 링크 설정 + 강제 이동 이벤트] 끝 === */
    
    /* ===== 데이터 로딩 ===== */
function makeUrl(nextY, nextM){
  const u = new URL(window.location.href);
  u.searchParams.set('y', String(nextY));
  u.searchParams.set('m', String(nextM));
  return u.toString();  // index 유무 그대로 유지
}
    var dayMap = Object.create(null);

    function parseText(text){
      if(text && text.charCodeAt && text.charCodeAt(0)===0xFEFF) text = text.slice(1);
      var lines = (text||'').replace(/\r\n?/g,'\n').split('\n');
      for(var i=0;i<lines.length;i++){
        var line = lines[i].trim(); if(!line) continue;
        var parts = line.split('|'); if(parts.length<2) continue;
        var dd = parseInt((parts[0]||'').trim(),10);
        if(!(dd>=1 && dd<=31)) continue;
        var title = (parts[1]||'').trim();
        var ref   = (parts[2]||'').trim();
        var url   = (parts[3]||'').trim();
        if(!dayMap[dd]) dayMap[dd] = {title:title, ref:ref, url:url, extraCount:0};
        else dayMap[dd].extraCount++;
      }
    }

    function tryFetch(i){
      if(i>=candidates.length){ render(); return; }
      fetch(candidates[i], {cache:'no-store'})
        .then(function(r){ return r.ok ? r.text() : ''; })
        .then(function(t){ if(t && t.trim().length){ parseText(t); render(); } else tryFetch(i+1); })
        .catch(function(){ tryFetch(i+1); });
    }
    tryFetch(0);

    /* ===== 렌더: URL 있으면 셀 전체를 <a class="cellbox">로 ===== */
    function render(){
      var grid = document.getElementById('grid'); grid.innerHTML='';
      var first = new Date(y, m-1, 1);
      var start = first.getDay();
      var days = new Date(y, m, 0).getDate();

      var cells = [];
      for(var i=0;i<start;i++) cells.push({empty:true});
      for(var d=1; d<=days; d++) cells.push({empty:false, day:d, info:dayMap[d]});
      while(cells.length%7!==0) cells.push({empty:true});

      for(var k=0;k<cells.length;k++){
        var c = cells[k];
        var cell = document.createElement('div');
        cell.className = 'cell' + (c.empty?' is-empty':'');
        if(c.empty){ grid.appendChild(cell); continue; }

        var info = c.info;
        var box;
        if(info && info.url){
          box = document.createElement('a');
          box.href = info.url; box.target = '_blank'; box.rel='noopener';
          box.className = 'cellbox';
        }else{
          box = document.createElement('div');
          box.className = 'cellbox';
        }

// ... 반복문 안, 각 날짜 셀 생성 부분만 발췌 ...
var cell = document.createElement('div');
cell.className = 'cell' + (c.empty ? ' is-empty' : '');
if(c.empty){ grid.appendChild(cell); continue; }

var info = c.info;
var box = (info && info.url) ? document.createElement('a') : document.createElement('div');
box.className = 'cellbox';
if(info && info.url){ box.href = info.url; box.target = '_blank'; box.rel = 'noopener'; }

// 날짜 배지 (좌상단 고정)
var badge = document.createElement('div');
badge.className = 'dnum-badge';
badge.textContent = c.day;
box.appendChild(badge);

// ✅ 중앙 영역(제목/부제/추가)
var center = document.createElement('div');
center.className = 'center';

// 제목 (멀티라인, 중앙)
var titleEl = document.createElement('div');
titleEl.className = 'title-center';
titleEl.textContent = (info && info.title) ? info.title : '';
center.appendChild(titleEl);

// 부제
if(info && info.ref){
  var r = document.createElement('div');
  r.className = 'ref';
  r.textContent = info.ref;
  center.appendChild(r);
}

// 추가 개수
if(info && info.extraCount > 0){
  var mline = document.createElement('div');
  mline.className = 'more';
  mline.textContent = '+' + info.extraCount + ' 더 있음';
  center.appendChild(mline);
}

box.appendChild(center);
cell.appendChild(box);
grid.appendChild(cell);
    
        /* 날짜 배지 (좌상단 고정) */
        var badge = document.createElement('div');
        badge.className = 'dnum-badge';
        badge.textContent = c.day;
        box.appendChild(badge);

        /* 제목 중앙 */
        var titleEl = document.createElement('div');
        titleEl.className = 'title-center';
        titleEl.textContent = (info && info.title) ? info.title : '';
        box.appendChild(titleEl);

        /* 본문/추가 갯수 (있을 때만) */
        if(info && info.ref){
          var r = document.createElement('div'); r.className='ref';
          r.textContent = info.ref; box.appendChild(r);
        }
        if(info && info.extraCount>0){
          var mline = document.createElement('div'); mline.className='more';
          mline.textContent = '+'+ info.extraCount +' 더 있음'; box.appendChild(mline);
        }

        cell.appendChild(box);
        grid.appendChild(cell);
      }
    }
  })();
  </script>
</body>
</html>
