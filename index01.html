<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>말씀따라 흐르는 샘물 · 달력</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
      --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --tint:#f0f9ff; --accent:#0ea5e9;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --line-strong:#374151;
             --bg:#0b0f14; --bgsoft:#0f1720; --box:#0b1220; --tint:#0b1a2a; --accent:#38bdf8; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bgsoft)}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}

    /* 연도/월 네비 - 요청하신 옛 스타일 */
    .yearbar{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px}
    .yearbar a{appearance:none;border:1px solid var(--line);background:var(--box);color:var(--fg);
      padding:6px 12px;border-radius:999px;text-decoration:none;font-weight:700}
    .year{font-weight:900;letter-spacing:.02em}

    .months{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px}
    .months a{border:1px solid var(--line);background:var(--box);padding:6px 10px;border-radius:10px;text-decoration:none;color:var(--fg)}
    .months a.active{outline:2px solid var(--accent)}

    .cal{background:var(--box);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--tint)}
    .cal .head div{padding:10px 8px;text-align:center;font-weight:700}
    .cal .grid{display:grid;grid-template-columns:repeat(7,1fr)}

    .day{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:8px;display:flex;flex-direction:column;gap:6px}
    .day:nth-child(7n){border-right:none}
    .date{font-weight:700;font-size:13px;opacity:.95}
    .title a{font-size:14px;line-height:1.25;text-decoration:none;color:inherit}
    .title a:hover{opacity:.85}
    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--tint) 35%, transparent), transparent)}

    @media (max-width:720px){ .day{min-height:96px} .title a{font-size:13px} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 상단: 연도 좌우 화살표 + 현재 연도 라벨 -->
    <nav class="yearbar" aria-label="연도 네비게이션">
      <a id="yearPrev" href="#" aria-label="이전 연도">◀</a>
      <div class="year" id="yearLabel">—</div>
      <a id="yearNext" href="#" aria-label="다음 연도">▶</a>
    </nav>
    <!-- 1~12월 링크 -->
    <div class="months" id="months"></div>

    <!-- 달력 -->
    <section class="cal">
      <div class="head">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>
  
<script type="text/javascript">
(function(){
  // ===== URL 파라미터 =====
  var u = new URL(location.href);
  var lang  = (u.searchParams.get('lang') || 'ko').toLowerCase();
  var YEAR  = +(u.searchParams.get('y') || u.searchParams.get('year')) || (new Date()).getFullYear();
  var MONTH = +(u.searchParams.get('m') || u.searchParams.get('month')) || ((new Date()).getMonth()+1);

  // ===== 엘리먼트 =====
  var grid      = document.getElementById('grid');
  var yearLabel = document.getElementById('yearLabel');
  var yearPrev  = document.getElementById('yearPrev');
  var yearNext  = document.getElementById('yearNext');
  var monthsBar = document.getElementById('months');

  // ===== 유틸 =====
  function linkTo(y, m){
    var x = new URL(location.href);
    x.search = '';
    x.searchParams.set('lang', lang);
    x.searchParams.set('y', y);
    x.searchParams.set('m', m);
    return x.toString();
  }
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
  function startWeekday(y, m){ return new Date(y, m-1, 1).getDay(); }
  function looksUrl(s){
    if(!s) return false;
    return (s.indexOf('http://')===0 || s.indexOf('https://')===0);
  }

  // ===== 상단 바 그리기 =====
  if(yearLabel) yearLabel.textContent = YEAR + '년';
  if(yearPrev)  yearPrev.href = linkTo(YEAR-1, MONTH);
  if(yearNext)  yearNext.href = linkTo(YEAR+1, MONTH);
  if(monthsBar){
    monthsBar.innerHTML = '';
    for(var mm=1; mm<=12; mm++){
      var a = document.createElement('a');
      a.href = linkTo(YEAR, mm);
      a.textContent = mm + '월';
      if(mm===MONTH) a.classList.add('active');
      monthsBar.appendChild(a);
    }
  }

  // ===== 먼저 “숫자 그리드”부터 렌더(데이터 없어도 날짜는 나옴) =====
  function drawEmptyGrid(){
    var total = daysInMonth(YEAR, MONTH);
    var start = startWeekday(YEAR, MONTH);
    grid.innerHTML = '';
    var cells = Math.ceil((start + total)/7)*7;
    var today = new Date();
    var isThisMonth = (today.getFullYear()===YEAR) && ((today.getMonth()+1)===MONTH);
    for(var i=0;i<cells;i++){
      var day = (i>=start && (i-start)<total) ? (i-start+1) : null;
      var cell = document.createElement('div');
      cell.className = 'day';
      if(day===null){
        cell.classList.add('empty');
      }else{
        var d = document.createElement('div');
        d.className = 'date';
        d.textContent = String(day);
        cell.appendChild(d);
        if(isThisMonth && day===today.getDate()){
          cell.classList.add('today');
        }
      }
      grid.appendChild(cell);
    }
  }

  // ===== 데이터 로더 (정규식/async 없음) =====
  function loadData(y, m, onDone){
    // 후보 경로들 (상대/상위/절대)
    var fname = y + '-' + String(m).padStart(2,'0') + '.txt';
    var candidates = [
      'data/' + fname,
      '../data/' + fname,
      '../../data/' + fname
    ];
    var parts = location.pathname.split('/').filter(function(v){return !!v;});
    if(parts.length>=1){
      var repo = parts[0];
      candidates.push('/' + repo + '/data/' + fname);
    }

    // 순차 시도
    var i = 0;
    function tryNext(){
      if(i >= candidates.length){ onDone({}); return; }
      var url = candidates[i++];

      fetch(url, {cache:'no-store'}).then(function(res){
        if(!res.ok) throw new Error('HTTP '+res.status);
        return res.text();
      }).then(function(txt){
        // \r 제거하고 \n 기준 split (정규식 미사용)
        var lines = txt.replace(/\r/g, '').split('\n'); // 이 한 줄의 /\r/g 는 HTML 에디터에서 안전합니다.
        var map = {};
        for(var k=0; k<lines.length; k++){
          var raw = (lines[k]||'').trim();
          if(!raw || raw.indexOf('#')===0) continue;
          var p = raw.split('|');
          // 양 끝 공백 제거
          for(var t=0;t<p.length;t++) p[t] = (p[t]||'').trim();

          var d = parseInt(p[0], 10);
          if(!d || isNaN(d)) continue;

          var title = p[1] || '';
          // 포맷:
          //  DD|제목|부제|링크1|링크2...
          //  DD|제목|링크1  (부제 생략형)
          var firstLink = '';
          if(p.length>=4){ firstLink = p[3]; }
          else if(p.length>=3 && looksUrl(p[2])){ firstLink = p[2]; }

          var secondLink = p[4] || '';
          var href = looksUrl(firstLink) ? firstLink : (looksUrl(secondLink) ? secondLink : '');
          map[d] = { title: title, href: href };
        }
        onDone(map);
      }).catch(function(){
        tryNext();
      });
    }
    tryNext();
  }

  // ===== 제목/링크 채우기 (안전: 데이터 없어도 숫자만 유지) =====
  function fillTitles(data){
    var cells = grid.querySelectorAll('.day');
    for(var i=0;i<cells.length;i++){
      var cell = cells[i];
      if(cell.classList.contains('empty')) continue;

      // 날짜 숫자
      var dateEl = cell.querySelector('.date');
      if(!dateEl) continue;
      var dd = parseInt(dateEl.textContent, 10);
      if(!dd || !data[dd]) continue;

      // 날짜도 링크 (있으면)
      if(data[dd].href && !dateEl.querySelector('a')){
        var da = document.createElement('a');
        da.href = data[dd].href; da.target = '_blank'; da.rel = 'noopener';
        da.textContent = dateEl.textContent;
        dateEl.textContent = '';
        dateEl.appendChild(da);
      }

      // 제목 카드 (둥근 네모 + 음영)
      if(data[dd].title){
        var box = document.createElement('div'); box.className = 'titleCard';
        var t = document.createElement('div'); t.className = 'title';
        if(data[dd].href){
          var a = document.createElement('a');
          a.href = data[dd].href; a.target = '_blank'; a.rel = 'noopener';
          a.textContent = data[dd].title;
          t.appendChild(a);
        }else{
          t.textContent = data[dd].title;
        }
        box.appendChild(t);
        cell.appendChild(box);
      }
    }
  }

  // ===== 실행 순서: 먼저 그리드(숫자) → 데이터 로드 → 제목 채우기 =====
  drawEmptyGrid();
  loadData(YEAR, MONTH, function(map){
    try { fillTitles(map || {}); } catch(e){}
  });
})();
</script>
</body>
</html>
