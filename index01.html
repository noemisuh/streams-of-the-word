<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>말씀따라 흐르는 샘물 · 달력</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
      --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --tint:#f0f9ff; --accent:#0ea5e9;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --line-strong:#374151;
             --bg:#0b0f14; --bgsoft:#0f1720; --box:#0b1220; --tint:#0b1a2a; --accent:#38bdf8; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bgsoft)}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}

    /* 연도/월 네비 - 요청한 스타일 */
    .yearbar{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px}
    .yearbar a{appearance:none;border:1px solid var(--line);background:var(--box);color:var(--fg);
      padding:6px 12px;border-radius:999px;text-decoration:none;font-weight:700}
    .year{font-weight:900;letter-spacing:.02em}

    .months{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px}
    .months a{border:1px solid var(--line);background:var(--box);padding:6px 10px;border-radius:10px;text-decoration:none;color:var(--fg)}
    .months a.active{outline:2px solid var(--accent)}

    .cal{background:var(--box);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--tint)}
    .cal .head div{padding:10px 8px;text-align:center;font-weight:700}
    .cal .grid{display:grid;grid-template-columns:repeat(7,1fr)}

    .day{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;transition:background .15s ease}
    .day:nth-child(7n){border-right:none}
    .day:hover{background:color-mix(in oklab, var(--tint) 30%, transparent)}
    .date{font-weight:800;font-size:13px;opacity:.95}
    .date a{color:inherit;text-decoration:none;display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:color-mix(in oklab, var(--tint) 55%, transparent)}
    .date a:hover{filter:brightness(0.96)}
    .title a{font-size:14px;line-height:1.3;text-decoration:none;color:inherit;display:block;overflow:hidden;text-overflow:ellipsis;-webkit-line-clamp:2; display:-webkit-box; -webkit-box-orient:vertical;font-weight:700}
    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--tint) 35%, transparent), transparent)}
    .titleCard{margin-top:2px;border:1px solid var(--line);background:color-mix(in oklab, var(--bg) 70%, var(--tint) 30%);border-radius:10px;padding:8px 10px;box-shadow:0 1px 0 color-mix(in oklab, var(--line) 80%, transparent)}
    .titleCard:hover{filter:brightness(0.98)}
    .today{outline:2px solid var(--accent); outline-offset:-2px; background:color-mix(in oklab, var(--tint) 45%, transparent)}

    @media (max-width:720px){ .day{min-height:96px} .title a{font-size:13px} }
  .brand{display:flex;align-items:center;gap:10px;margin:2em 0 10px}
    .brand .dot{width:12px;height:12px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent)}
    .title-site{margin:0;font-weight:900;letter-spacing:.02em}

    .yearbar{margin-top:8px}

    .day{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;transition:background .15s ease}
    .day:nth-child(7n){border-right:none}
    .day:hover{background:color-mix(in oklab, var(--tint) 30%, transparent)}
    .date{font-weight:800;font-size:13px;opacity:.95}
    .title a{font-size:28px;line-height:1.25;text-decoration:none;color:inherit;display:block;overflow:hidden;text-overflow:ellipsis;-webkit-line-clamp:2; display:-webkit-box; -webkit-box-orient:vertical;font-weight:800}
    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--tint) 35%, transparent), transparent)}
    .today{outline:2px solid var(--accent); outline-offset:-2px; background:color-mix(in oklab, var(--tint) 45%, transparent)}

    @media (max-width:720px){ .day{min-height:96px} .title a{font-size:22px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="brand">
      <span class="dot" aria-hidden="true"></span>
      <h1 class="title-site">말씀따라 흐르는 샘물</h1>
    </header>
    <!-- 상단: 연도 좌우 화살표 + 현재 연도 라벨 -->
    <nav class="yearbar" aria-label="연도 네비게이션">
      <a id="yearPrev" href="#" aria-label="이전 연도">◀</a>
      <div class="year" id="yearLabel">—</div>
      <a id="yearNext" href="#" aria-label="다음 연도">▶</a>
    </nav>
    <!-- 1~12월 링크 -->
    <div class="months" id="months"></div>

    <!-- 달력 -->
    <section class="cal">
      <div class="head">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

<script>
(function(){
  // ===== helpers =====
  const U = new URL(location.href);
  const lang = (U.searchParams.get('lang')||'ko').toLowerCase();
  const YEAR = +(U.searchParams.get('y')||U.searchParams.get('year')) || new Date().getFullYear();
  const MONTH = +(U.searchParams.get('m')||U.searchParams.get('month')) || (new Date().getMonth()+1);

  const grid = document.getElementById('grid');
  const yearLabel = document.getElementById('yearLabel');
  const yearPrev = document.getElementById('yearPrev');
  const yearNext = document.getElementById('yearNext');
  const monthsBar = document.getElementById('months');

  function linkTo(y, m){
    const u = new URL(location.href);
    u.search = '';
    u.searchParams.set('lang', lang);
    u.searchParams.set('y', y);
    u.searchParams.set('m', m);
    return u.toString();
  }
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
  function startWeekday(y, m){ return new Date(y, m-1, 1).getDay(); }

  // ===== top bars =====
  yearLabel.textContent = `${YEAR}년`;
  yearPrev.href = linkTo(YEAR-1, MONTH);
  yearNext.href = linkTo(YEAR+1, MONTH);
  monthsBar.innerHTML = '';
  for(let mm=1; mm<=12; mm++){
    const a=document.createElement('a');
    a.href = linkTo(YEAR, mm);
    a.textContent = `${mm}월`;
    if(mm===MONTH) a.classList.add('active');
    monthsBar.appendChild(a);
  }

  // ===== data loader (robust) =====
  async function loadData(y, m){
    const fname = `${y}-${String(m).padStart(2,'0')}.txt`;
    const candidates = [
      `data/${fname}`,
      `../data/${fname}`,
      `../../data/${fname}`
    ];
    const parts = location.pathname.split('/').filter(Boolean);
    if(parts.length>=1){
      const repo = parts[0];
      candidates.push(`/${repo}/data/${fname}`);
    }

    const looksUrl = (s)=>/^https?:\/\//i.test(s||'');

    for(const url of candidates){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(res.status);
        const txt = await res.text();
        const map={};
        txt.split(/
?
/).forEach(line=>{
          const raw=line.trim();
          if(!raw || raw.startsWith('#')) return;
          const p=raw.split('|').map(v=>v.trim());
          const d=+p[0]; if(!Number.isInteger(d)) return;
          const title=p[1]||'';
          // 지원 포맷:
          //  DD|제목|부제|링크1|링크2...
          //  DD|제목|링크1 (부제 생략형)
          let firstLink='';
          if(p.length>=4){ firstLink=p[3]; }
          else if(p.length>=3 && looksUrl(p[2])){ firstLink=p[2]; }
          const secondLink = p[4]||'';
          const href = looksUrl(firstLink) ? firstLink : (looksUrl(secondLink) ? secondLink : '');
          map[d]={title, href};
        });
        return map;
      }catch(e){ /* try next candidate */ }
    }
    console.warn('데이터 파일을 찾지 못했습니다:', fname, candidates);
    return {};
  }

    const urlLike = (s)=>/^https?:\/\//i.test(s||'');

    for(const url of candidates){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(res.status);
        const txt = await res.text();
        const map={};
        txt.split(/
?
/).forEach(line=>{
          const raw=line.trim();
          if(!raw || raw.startsWith('#')) return;
          const p=raw.split('|').map(v=>v.trim());
          const d=+p[0]; if(!Number.isInteger(d)) return;
          const title=p[1]||'';
          // 지원 포맷:
          //  DD|제목|부제|링크1|링크2...
          //  DD|제목|링크1 (부제 생략형)
          let href='';
          if(p.length>=4){ href=p[3]; }
          else if(p.length>=3 && urlLike(p[2])){ href=p[2]; }
          map[d]={title, href};
        });
        return map;
      }catch(e){ /* try next candidate */ }
    }
    console.warn('데이터 파일을 찾지 못했습니다:', fname, candidates);
    return {};
  }

  // ===== cell factory =====
  function makeCell(day, entry){
    const div=document.createElement('div');
    div.className='day';
    if(day==null){ div.classList.add('empty'); return div; }

    // 날짜 (href 있으면 날짜도 링크)
    const d=document.createElement('div'); d.className='date';
    if(entry && entry.href){
      const da=document.createElement('a'); da.href=entry.href; da.target='_blank'; da.rel='noopener'; da.textContent=String(day);
      d.appendChild(da);
    }else{
      d.textContent=String(day);
    }
    div.appendChild(d);

    // 제목 박스 (둥근 네모 + 살짝 음영)
    if(entry && entry.title){
      const box=document.createElement('div'); box.className='titleCard';
      const t=document.createElement('div'); t.className='title';
      if(entry.href){
        const a=document.createElement('a'); a.href=entry.href; a.target='_blank'; a.rel='noopener'; a.textContent=entry.title;
        t.appendChild(a);
      }else{ t.textContent=entry.title; }
      box.appendChild(t);
      div.appendChild(box);
    }
    return div;
  })();
  // ===== render =====
  (async function render(){
    const total=daysInMonth(YEAR, MONTH);
    const start=startWeekday(YEAR, MONTH);
    const data=await loadData(YEAR, MONTH);

    grid.innerHTML='';
    const cells=Math.ceil((start+total)/7)*7;
    const today=new Date();
    const isThisMonth = (today.getFullYear()===YEAR) && ((today.getMonth()+1)===MONTH);

    for(let i=0;i<cells;i++){
      const day=(i>=start && (i-start)<total)?(i-start+1):null;
      const cell=makeCell(day, day? data[day] : null);
      if(isThisMonth && day===today.getDate()) cell.classList.add('today');
      grid.appendChild(cell);
    }
  })();
})();
</script>
</body>
</html>
