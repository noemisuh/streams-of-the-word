<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>말씀따라 흐르는 샘물 · 달력</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
      --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --tint:#f0f9ff; --accent:#0ea5e9;
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --line-strong:#374151;
             --bg:#0b0f14; --bgsoft:#0f1720; --box:#0b1220; --tint:#0b1a2a; --accent:#38bdf8; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bgsoft)}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}

    /* 연도/월 네비 - 요청한 스타일 */
    .yearbar{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px}
    .yearbar a{appearance:none;border:1px solid var(--line);background:var(--box);color:var(--fg);
      padding:6px 12px;border-radius:999px;text-decoration:none;font-weight:700}
    .year{font-weight:900;letter-spacing:.02em}

    .months{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px}
    .months a{border:1px solid var(--line);background:var(--box);padding:6px 10px;border-radius:10px;text-decoration:none;color:var(--fg)}
    .months a.active{outline:2px solid var(--accent)}

    .cal{background:var(--box);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--tint)}
    .cal .head div{padding:10px 8px;text-align:center;font-weight:700}
    .cal .grid{display:grid;grid-template-columns:repeat(7,1fr)}

    .day{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;transition:background .15s ease}
    .day:nth-child(7n){border-right:none}
    .day:hover{background:color-mix(in oklab, var(--tint) 30%, transparent)}
    .date{font-weight:800;font-size:13px;opacity:.95}
    .date a{color:inherit;text-decoration:none;display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:color-mix(in oklab, var(--tint) 55%, transparent)}
    .date a:hover{filter:brightness(0.96)}
    .title a{font-size:14px;line-height:1.3;text-decoration:none;color:inherit;display:block;overflow:hidden;text-overflow:ellipsis;-webkit-line-clamp:2; display:-webkit-box; -webkit-box-orient:vertical;font-weight:700}
    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--tint) 35%, transparent), transparent)}
    .titleCard{margin-top:2px;border:1px solid var(--line);background:color-mix(in oklab, var(--bg) 70%, var(--tint) 30%);border-radius:10px;padding:8px 10px;box-shadow:0 1px 0 color-mix(in oklab, var(--line) 80%, transparent)}
    .titleCard:hover{filter:brightness(0.98)}
    .today{outline:2px solid var(--accent); outline-offset:-2px; background:color-mix(in oklab, var(--tint) 45%, transparent)}

    @media (max-width:720px){ .day{min-height:96px} .title a{font-size:13px} }
  .brand{display:flex;align-items:center;gap:10px;margin:2em 0 10px}
    .brand .dot{width:12px;height:12px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent)}
    .title-site{margin:0;font-weight:900;letter-spacing:.02em}

    .yearbar{margin-top:8px}

    .day{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;transition:background .15s ease}
    .day:nth-child(7n){border-right:none}
    .day:hover{background:color-mix(in oklab, var(--tint) 30%, transparent)}
    .date{font-weight:800;font-size:13px;opacity:.95}
    .title a{font-size:28px;line-height:1.25;text-decoration:none;color:inherit;display:block;overflow:hidden;text-overflow:ellipsis;-webkit-line-clamp:2; display:-webkit-box; -webkit-box-orient:vertical;font-weight:800}
    .empty{background:linear-gradient(180deg, color-mix(in oklab, var(--tint) 35%, transparent), transparent)}
    .today{outline:2px solid var(--accent); outline-offset:-2px; background:color-mix(in oklab, var(--tint) 45%, transparent)}

    @media (max-width:720px){ .day{min-height:96px} .title a{font-size:22px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="brand">
      <span class="dot" aria-hidden="true"></span>
      <h1 class="title-site">말씀따라 흐르는 샘물</h1>
    </header>
    <!-- 상단: 연도 좌우 화살표 + 현재 연도 라벨 -->
    <nav class="yearbar" aria-label="연도 네비게이션">
      <a id="yearPrev" href="#" aria-label="이전 연도">◀</a>
      <div class="year" id="yearLabel">—</div>
      <a id="yearNext" href="#" aria-label="다음 연도">▶</a>
    </nav>
    <!-- 1~12월 링크 -->
    <div class="months" id="months"></div>

    <!-- 달력 -->
    <section class="cal">
      <div class="head">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

<script type="text/javascript">
(function(){
  // ---- URL 파라미터: y/m 또는 year/month 지원 ----
  var u = new URL(location.href);
  var Y = +(u.searchParams.get('y') || u.searchParams.get('year')) || (new Date()).getFullYear();
  var M = +(u.searchParams.get('m') || u.searchParams.get('month')) || ((new Date()).getMonth()+1);

  // ---- 유틸 ----
  function looksUrl(s){ return !!s && (s.indexOf('http://')===0 || s.indexOf('https://')===0); }
  function pad2(n){ return (n<10?'0':'')+n; }

  // ---- 그리드/셀 탐색 (네 기존 틀 최대한 존중) ----
  var grid = document.getElementById('grid')
         || document.querySelector('[data-cal-grid]')
         || document.querySelector('.calendar-grid')
         || document.querySelector('.grid'); // 최후 후보
  if(!grid){ console.warn('grid를 못 찾음'); return; }

  function cellList(){
    // 흔한 케이스: .day가 셀
    var cells = grid.querySelectorAll('.day');
    if(cells && cells.length) return cells;
    // fallback: 자식들을 모두 셀로 간주
    return grid.children || [];
  }

  function getDayFromCell(cell){
    // 1) .date 내부 텍스트
    var d = cell.querySelector('.date');
    if(d){
      var n = parseInt(String(d.textContent||'').trim(),10);
      if(n>=1 && n<=31) return n;
    }
    // 2) data-day 속성
    var attr = cell.getAttribute && cell.getAttribute('data-day');
    if(attr){ var n2 = parseInt(attr,10); if(n2>=1 && n2<=31) return n2; }
    // 3) 셀 텍스트에서 앞 숫자 추출(정규식 없이)
    var txt = String(cell.textContent||'').trim();
    var num = ''; for(var i=0;i<txt.length;i++){ var ch=txt.charCodeAt(i); if(ch>=48 && ch<=57){ num+=txt[i]; } else break; }
    var n3 = parseInt(num,10); if(n3>=1 && n3<=31) return n3;
    return null;
  }

  // ---- 스타일 살짝만 (제목 박스+글자 크기) ----
  (function injectCSS(){
    var css = ""
      + ".titleCard{margin-top:2px;border:1px solid #e5e7eb;background:rgba(0,0,0,.03);border-radius:10px;padding:8px 10px;box-shadow:0 1px 0 rgba(0,0,0,.05)}"
      + ".titleCard .title a{font-size:18px;line-height:1.3;text-decoration:none;color:inherit;display:block;overflow:hidden;text-overflow:ellipsis}"
      + "@media (max-width:720px){ .titleCard .title a{font-size:16px} }"
      + ".date a{color:inherit;text-decoration:none;display:inline-block;padding:2px 6px;border:1px solid #e5e7eb;border-radius:8px;background:rgba(0,0,0,.03)}";
    var s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
  })();

  // ---- 데이터 로드 (여러 경로 시도: data/YYYY-MM.txt) ----
  function loadData(y,m,done){
    var fname = y+"-"+pad2(m)+".txt";
    var candidates = [
      "data/"+fname,
      "../data/"+fname,
      "../../data/"+fname
    ];
    var parts = location.pathname.split('/').filter(function(v){return !!v;});
    if(parts.length>=1){ candidates.push("/"+parts[0]+"/data/"+fname); }

    var i=0;
    function next(){
      if(i>=candidates.length){ done({}); return; }
      var url = candidates[i++];
      fetch(url,{cache:"no-store"}).then(function(res){
        if(!res.ok) throw new Error("HTTP "+res.status);
        return res.text();
      }).then(function(txt){
        // \r 제거 (정규식 없이)
        var raw = txt, lines = [], arr = raw.split("\n");
        for(var k=0;k<arr.length;k++){
          var line = arr[k];
          if(line && line.length && line.charCodeAt(line.length-1)===13) line = line.slice(0,-1);
          lines.push(line);
        }
        var map = {};
        for(var j=0;j<lines.length;j++){
          var L = (lines[j]||"").trim();
          if(!L || L.charAt(0)==="#") continue;
          var p = L.split("|"); for(var t=0;t<p.length;t++){ p[t]=(p[t]||"").trim(); }
          var day = parseInt(p[0],10); if(!day || isNaN(day)) continue;
          var title = p[1] || "";
          // DD|제목|부제|링크1|링크2...  또는  DD|제목|링크1
          var first = "";
          if(p.length>=4){ first = p[3]; }
          else if(p.length>=3 && looksUrl(p[2])){ first = p[2]; }
          var second = p[4] || "";
          var href = looksUrl(first) ? first : (looksUrl(second) ? second : "");
          map[day] = { title:title, href:href };
        }
        done(map);
      }).catch(function(){ next(); });
    }
    next();
  }

  // ---- 제목/링크 꽂기 (기존 마크업 최대 존중) ----
  function fill(data){
    var cells = cellList();
    for(var i=0;i<cells.length;i++){
      var cell = cells[i];
      // 비어있는 주간칸은 건너뜀
      if(cell.classList && cell.classList.contains('empty')) continue;

      var dd = getDayFromCell(cell);
      if(!dd || !data[dd]) continue;

      var info = data[dd];

      // 날짜 숫자 요소
      var dateEl = cell.querySelector('.date') || null;
      if(dateEl && info.href && !dateEl.querySelector('a')){
        var da = document.createElement('a');
        da.href = info.href; da.target = "_blank"; da.rel="noopener";
        da.textContent = String(dd);
        dateEl.textContent = "";
        dateEl.appendChild(da);
      }

      // 제목 넣을 위치: 기존 제목 요소 우선, 없으면 새로 만듦
      var titleWrap =
        cell.querySelector('.titleCard') ||
        cell.querySelector('.title')?.parentElement ||
        null;

      if(!titleWrap){
        titleWrap = document.createElement('div');
        titleWrap.className = 'titleCard';
        cell.appendChild(titleWrap);
      }else{
        // 기존 박스가 제목/링크 버튼들을 품고 있었다면 비워서 새로
        if(titleWrap.classList.contains('titleCard')) titleWrap.innerHTML = '';
      }

      var titleDiv = titleWrap.querySelector('.title');
      if(!titleDiv){ titleDiv = document.createElement('div'); titleDiv.className='title'; titleWrap.appendChild(titleDiv); }
      titleDiv.innerHTML = '';

      if(info.title){
        if(info.href){
          var a = document.createElement('a');
          a.href = info.href; a.target = "_blank"; a.rel = "noopener";
          a.textContent = info.title;
          titleDiv.appendChild(a);
        }else{
          titleDiv.textContent = info.title;
        }
      }
    }
  }

  // ---- 실행 ----
  loadData(Y, M, function(map){
    try { fill(map||{}); } catch(e){ console.warn(e); }
  });
})();
</script>
</body>
</html>
