<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<!-- StreamsCal v1.0 (fixed template) -->
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --line:#d1d5db; --line-strong:#9ca3af;
    --accent:#0ea5e9; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff; --box-line:#d1d5db; --box-tint:#f0f9ff;
    --cell-h:112px; /* 최초 임시값, 렌더 후 9/29 기준으로 자동 재설정 */
  }
  @media (prefers-color-scheme: dark){
    :root{ --fg:#e5e7eb; --muted:#9ca3af; --line:#2b2f36; --line-strong:#4b5563; --bg:#0b0f14; --bgsoft:#0f141b; --box:#0f141b; --box-line:#283041; --box-tint:#0a2032; }
  }
  *{box-sizing:border-box}
  body{margin:0;color:var(--fg);background:var(--bg);font:14px/1.6 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif;}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
  .brand{font-weight:800}
  .ym{display:flex;align-items:center;gap:8px}
  .ym button{border:1px solid var(--line);background:var(--box);padding:6px 10px;border-radius:8px;cursor:pointer}
  .ym .badge{padding:6px 10px;border-radius:999px;background:var(--box-tint);border:1px solid var(--box-line);font-weight:600}
  .note{color:var(--muted);font-size:12px}
  .cal{background:var(--box);border:1px solid var(--box-line);border-radius:14px;overflow:hidden}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft)}
  .cal .head > div{padding:10px 6px;text-align:center;font-weight:700;color:var(--muted)}
  #grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--line-strong)}
  #grid > div{background:var(--box);padding:8px;min-height:var(--cell-h);max-height:var(--cell-h);overflow:hidden;border-radius:8px;word-break:break-word}
  #grid > div .date{font-weight:700;font-size:12px;opacity:.85;margin-bottom:4px}
  #grid > div .title{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden}
  #grid > div.empty{color:transparent}
  footer{margin-top:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">말씀따라 흐르는 샘물</div>
    <div class="ym">
      <button id="prevBtn" aria-label="이전 달">⬅︎</button>
      <div class="badge" id="ymLabel">—</div>
      <button id="nextBtn" aria-label="다음 달">➡︎</button>
    </div>
  </header>

  <section class="cal" aria-label="달력">
    <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
    <div id="grid" role="grid" aria-label="달력 그리드"></div>
  </section>

  <footer>
    StreamsCal v1.0 • 칸 높이: 2025-09-29 기준(없으면 해당 달 최대 높이)
  </footer>
</div>

<script>
/* ===== [A] 상태 & 파라미터 ===== */
const url = new URL(location.href);
const now = new Date();
const guardYear  = v => { const n = +v; return Number.isInteger(n)&&n>=1900&&n<=9999 ? n : now.getFullYear(); };
const guardMonth = v => { const n = +v; return Number.isInteger(n)&&n>=1&&n<=12   ? (n-1) : now.getMonth(); };
let state = {
  year:  guardYear(url.searchParams.get('y')),
  month: guardMonth(url.searchParams.get('m'))   // 0-based
};
const ymLabel = document.getElementById('ymLabel');
const grid    = document.getElementById('grid');

/* ===== [B] 유틸 ===== */
const pad2 = n => (n<10?'0':'')+n;
const lastDayOfMonth = (y,m0) => new Date(y, m0+1, 0).getDate();
const startWeekday   = (y,m0) => new Date(y, m0, 1).getDay();
function normalizeYM(){ if(state.month<0){state.year--;state.month=11;} if(state.month>11){state.year++;state.month=0;} }

/* ===== [C] 균일 높이(9/29 기준) ===== */
function lockUniformCellHeightByDate(targetDay){
  const cells = Array.from(document.querySelectorAll('#grid > div'));
  if(!cells.length) return;
  let h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-h')) || 0;
  let ref = cells.find(c => { const d = c.querySelector('.date'); return d && d.textContent.trim() === String(targetDay); });
  if(ref){ h = Math.round(ref.getBoundingClientRect().height); }
  else   { h = Math.round(Math.max(...cells.map(c => c.getBoundingClientRect().height))); }
  document.documentElement.style.setProperty('--cell-h', h + 'px');
  cells.forEach(c => { c.style.minHeight = h+'px'; c.style.maxHeight = h+'px'; });
}

/* ===== [D] 외부 데이터 로더 (data/YYYY-MM.txt) ===== */
async function loadMonthData(y, m0){
  // index03.html이 어디에 있든, 그 위치 기준 상대경로로 data/를 찾음
  const base = new URL('./', location.href);
  const txtUrl = new URL(`data/${y}-${pad2(m0+1)}.txt`, base);
  txtUrl.searchParams.set('v', Date.now()); // 캐시 무력화

  try{
    const res = await fetch(txtUrl.toString(), {cache:'no-store'});
    if(!res.ok) return {};
    const text = await res.text();
    const map = {};
    text.split(/\r?\n/).forEach(raw=>{
      const line = raw.trim();
      if(!line || line.startsWith('#')) return;
      const parts = line.split('|').map(s=>s.trim());
      const day = parseInt(parts[0], 10);
      if(!Number.isInteger(day) || day<1 || day>31) return;

      const title = parts[1] || '';
      const last  = parts[parts.length-1] || '';
      const href  = /^https?:\/\//i.test(last) ? last : '';

      const key = `${y}-${pad2(m0+1)}-${pad2(day)}`;
      map[key] = { title, href };
    });
    return map;
  }catch(_){ return {}; }
}

/* ===== [E] 렌더러 ===== */
async function renderCalendar(){
  const y = state.year, m0 = state.month;
  ymLabel.textContent = `${y}년 ${m0+1}월`;

  const total = lastDayOfMonth(y,m0);
  const start = startWeekday(y,m0);
  const dataMap = await loadMonthData(y, m0);

  let html = '';
  const cells = 42; // 6주
  for(let i=0;i<cells;i++){
    const dayNum = i - start + 1;
    if(dayNum<1 || dayNum>total){ html += `<div class="empty">&nbsp;</div>`; continue; }
    const key   = `${y}-${pad2(m0+1)}-${pad2(dayNum)}`;
    const info  = dataMap[key];
    const title = info?.title || '';
    const link  = info?.href  || '';

    const body = title ? (link ? `<a href="${link}" target="_blank" rel="noopener">${title}</a>` : title) : '&nbsp;';
    html += `<div data-day="${dayNum}"><div class="date">${dayNum}</div><div class="title">${body}</div></div>`;
  }
  grid.innerHTML = html;

  requestAnimationFrame(()=> lockUniformCellHeightByDate(29));
}

/* ===== [F] 이벤트 ===== */
document.getElementById('prevBtn').addEventListener('click', async ()=>{
  state.month--; normalizeYM(); await renderCalendar();
});
document.getElementById('nextBtn').addEventListener('click', async ()=>{
  state.month++; normalizeYM(); await renderCalendar();
});

/* ===== [G] 최초 렌더 ===== */
renderCalendar();
</script>
</body>
</html>
