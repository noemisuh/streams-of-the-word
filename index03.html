<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>말씀따라 흐르는 샘물</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --line-strong:#cbd5e1;
    --accent:#0ea5e9; --accent-weak:#e0f2fe; --bg:#ffffff; --bgsoft:#f8fafc; --box:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#e5e7eb; --muted:#9ca3af; --line:#26303a; --line-strong:#334155;
      --accent:#38bdf8; --accent-weak:#0b2a3a; --bg:#0b0f14; --bgsoft:#0f1720; --box:#0f1720;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;}
  .wrap{max-width:1080px;margin:0 auto;padding:24px 16px;}

  /* 상단 */
  .top{display:grid;grid-template-rows:48px 40px 40px;row-gap:12px;}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.02em;font-size:22px;}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);}
  .yearbar{display:flex;justify-content:center;align-items:center;gap:16px;}
  .yearbar a{text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid var(--line-strong);background:var(--box);color:var(--fg);}
  .yearbar .yr{min-width:90px;text-align:center;font-weight:700;border:none;background:transparent;color:var(--fg);}
  .monthbar{display:flex;flex-wrap:wrap;justify-content:center;gap:6px 10px;}
  .monthbar a{text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--fg);background:var(--box);}
  .monthbar a.active{border-color:var(--accent);outline:2px solid var(--accent-weak);}

  /* 달력 */
  .cal{margin-top:18px;border:1px solid var(--line-strong);border-radius:14px;overflow:hidden;background:var(--box);}
  .cal .head{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--line-strong);background:var(--bgsoft);}
  .cal .head div{padding:10px 8px;text-align:center;font-weight:700;color:var(--muted);}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);}
  .cell{min-height:110px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);
    padding:8px 8px 10px;display:flex;flex-direction:column;gap:4px;}
  .grid .cell:nth-child(7n){border-right:none;}
  .grid .cell.is-empty{background:linear-gradient(180deg, transparent 0 70%, rgba(0,0,0,.02) 70% 100%);}
  .dnum{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;}
  .title{font-size:14px;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .title a{color:inherit;text-decoration:none;}
  .title a:hover{text-decoration:underline;}
  .ref{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .more{font-size:11px;color:var(--muted);}
  @media (max-width:640px){.cell{min-height:90px}.title{font-size:13px}}
</style>
</head>
<body>
  <div class="wrap">
    <section class="top" aria-label="상단">
      <div class="brand"><span class="dot" aria-hidden="true"></span><span>말씀따라 흐르는 샘물</span></div>
      <nav class="yearbar" aria-label="년도">
        <a id="prevYear" href="#">◀</a>
        <span class="yr" id="yearLabel">2025</span>
        <a id="nextYear" href="#">▶</a>
      </nav>
      <nav class="monthbar" id="monthbar" aria-label="월"></nav>
    </section>

    <section class="cal" aria-label="달력">
      <div class="head"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"></div>
    </section>
  </div>

  <!-- 스크립트 하나로 끝 (정규식/async 없음) -->
  <script>
  (function(){
    // ========= URL 파라미터 견고 파서 =========
    // 쿼리 문자열 어지러워도 마지막으로 보이는 숫자 y/m을 정확히 잡아냄.
    var qs = location.search || "";
    function pickLastNum(keyFallback, fallback){
      // 1) 표준 파라미터 우선
      var u = new URL(location.href);
      var v = u.searchParams.get(keyFallback);
      // 2) 전체 쿼리에서 key 형태(y=, year= 등)가 여러 번 등장하면 "마지막 숫자"를 사용
      var re = new RegExp("(?:\\b"+keyFallback+"\\b|\\byear\\b|\\bmonth\\b|\\bm\\b|\\by\\b)\\s*=\\s*(\\d{1,4})","gi");
      var m, last=null;
      while((m = re.exec(qs))){ last = m[1]; }
      var cand = (last!==null)? last : v;
      var n = parseInt(cand,10);
      return (isFinite(n)? n : fallback);
    }

    var today = new Date();
    var y = pickLastNum('y', today.getFullYear());
    if(!(y>=1900 && y<=9999)) y = today.getFullYear();
    var m = pickLastNum('m', (today.getMonth()+1));
    if(!(m>=1 && m<=12)) m = today.getMonth()+1;

    // ========= 기존 파라미터 보존한 링크 만들기 =========
    function makeUrl(nextY, nextM){
      var u = new URL(location.href);
      // 기존 쿼리 유지하되, y/m은 교체
      u.searchParams.set('y', String(nextY));
      u.searchParams.set('m', String(nextM));
      return u.pathname.split('/').pop() + u.search;
    }

    // 상단 표시
    document.getElementById('yearLabel').textContent = y;
    document.getElementById('prevYear').href = makeUrl(y-1, m);
    document.getElementById('nextYear').href = makeUrl(y+1, m);

    // 월바
    (function buildMonthbar(){
      var box = document.getElementById('monthbar'); box.innerHTML='';
      for(var i=1;i<=12;i++){
        var a = document.createElement('a');
        a.textContent = i+'월';
        a.href = makeUrl(y, i);
        if(i===m) a.className='active';
        box.appendChild(a);
      }
    })();

    // ========= 데이터 로딩 (경로 자동 판별 + BOM/개행 안전) =========
    var ym = y + '-' + String(m).padStart(2,'0') + '.txt';

    // 현재 파일이 있는 디렉터리 기준, 그리고 루트 기준 두 군데 다 시도
    var basePath = location.pathname.replace(/[^\/]*$/, '');
    var candidates = [ basePath + 'data/' + ym, '/data/' + ym ];

    var dayMap = Object.create(null);

    function parseText(text){
      // UTF-8 BOM 제거
      if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
      var lines = text.replace(/\r\n?/g,'\n').split('\n');
      for(var i=0;i<lines.length;i++){
        var line = lines[i].trim();
        if(!line) continue;
        var parts = line.split('|');
        if(parts.length<2) continue;
        var dd = parseInt((parts[0]||'').trim(),10);
        if(!(dd>=1 && dd<=31)) continue;
        var title = (parts[1]||'').trim();
        var ref   = (parts[2]||'').trim();
        var url   = (parts[3]||'').trim();
        if(!dayMap[dd]) dayMap[dd] = {title:title, ref:ref, url:url, extraCount:0};
        else dayMap[dd].extraCount++;
      }
    }

    function tryFetch(i){
      if(i>=candidates.length){ render(); return; }
      fetch(candidates[i], {cache:'no-store'})
        .then(function(r){ return r.ok ? r.text() : ''; })
        .then(function(t){ if(t.trim().length){ parseText(t); render(); } else tryFetch(i+1); })
        .catch(function(){ tryFetch(i+1); });
    }

    tryFetch(0);

    // ========= 렌더 =========
    function render(){
      var grid = document.getElementById('grid'); grid.innerHTML='';
      var first = new Date(y, m-1, 1);
      var start = first.getDay();
      var days = new Date(y, m, 0).getDate();

      var cells = [];
      for(var i=0;i<start;i++) cells.push({empty:true});
      for(var d=1; d<=days; d++) cells.push({empty:false, day:d, info:dayMap[d]});
      while(cells.length%7!==0) cells.push({empty:true});

      for(var k=0;k<cells.length;k++){
        var c = cells[k];
        var el = document.createElement('div');
        el.className = 'cell' + (c.empty?' is-empty':'');
        if(c.empty){ grid.appendChild(el); continue; }

        var dline = document.createElement('div'); dline.className='dnum';
        dline.innerHTML = '<span>'+c.day+'</span>';
        el.appendChild(dline);

        if(c.info){
          var t = document.createElement('div'); t.className='title';
          if(c.info.url){
            var a=document.createElement('a'); a.href=c.info.url; a.target='_blank'; a.rel='noopener';
            a.textContent=c.info.title||'(제목)';
            t.appendChild(a);
          }else{
            t.textContent=c.info.title||'(제목)';
          }
          el.appendChild(t);

          if(c.info.ref){
            var r=document.createElement('div'); r.className='ref'; r.textContent=c.info.ref; el.appendChild(r);
          }
          if(c.info.extraCount>0){
            var mline=document.createElement('div'); mline.className='more';
            mline.textContent='+'+c.info.extraCount+' 더 있음'; el.appendChild(mline);
          }
        }else{
          var t0=document.createElement('div'); t0.className='title'; t0.textContent='';
          el.appendChild(t0);
        }
        grid.appendChild(el);
      }
    }
  })();
  </script>
</body>
</html>
