<body>
  <main style="max-width:1080px;margin:24px auto;padding:0 16px;">
    <!-- 제목 -->
    <header style="margin-bottom:16px;">
      <h1 style="margin:0 0 8px 0;">말씀따라 흐르는 샘물</h1>
      <div id="cal-status" style="font-size:12px;color:#6b7280;display:none;"></div>
    </header>

    <!-- 연도 네비게이션 -->
    <nav id="yearbar" aria-label="연도 이동" style="display:flex;align-items:center;gap:12px;margin:8px 0 12px 0;">
      <button id="prevYear" type="button">◀</button>
      <strong id="yearLabel"></strong>
      <button id="nextYear" type="button">▶</button>
      <span style="margin-left:auto;font-size:13px;color:#6b7280">언어: 한국어</span>
    </nav>

    <!-- 월 링크 -->
    <nav id="monthbar" aria-label="월 이동" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
      <!-- 1~12월 자동 생성 -->
    </nav>

    <!-- 요일 헤더 -->
    <section class="cal">
      <div class="head" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;font-weight:600;">
        <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
      </div>
      <div id="grid" class="grid" role="grid" aria-label="달력 그리드"
           style="display:grid;grid-template-rows:repeat(6,1fr);gap:6px;">
        <!-- 스크립트가 채움 -->
      </div>
    </section>
  </main>

  <style>
    .row{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;min-height:96px}
    .cell{border:1px solid #d1d5db;border-radius:8px;padding:8px;background:#fff}
    .d{font-size:12px;color:#6b7280;margin-bottom:4px}
    .t{font-size:14px;line-height:1.4;word-break:break-word}
    .t.muted{color:#9ca3af}
    .ref{font-size:12px;color:#6b7280}
    a.t{color:#0b68d0;text-decoration:none}
    a.t:hover{text-decoration:underline}
    @media (prefers-color-scheme: dark){
      .cell{background:#0b0f14;border-color:#2b2f36}
      .d{color:#9ca3af}
      .t.muted{color:#6b7280}
      a.t{color:#7bb2ff}
    }
  </style>

  <script>
  (()=> {
    // ===== 유틸 =====
    const u = new URL(location.href);
    const get = (k, d="") => (u.searchParams.get(k)||d).trim();
    const pad2 = n => String(n).padStart(2,"0");
    const now = new Date();

    // ===== 파라미터 파싱 (가드) =====
    const lang = "ko"; // 한글 고정 (다국어는 나중에 lang=ko|es 등으로 확장)
    const year = (get("y", String(now.getFullYear())).match(/^\d{4}$/) || [String(now.getFullYear())])[0];
    const mRaw = get("m", String(now.getMonth()+1));
    const month = (mRaw.match(/^\d{1,2}$/) ? pad2(mRaw) : pad2(now.getMonth()+1));

    const status = document.getElementById("cal-status");
    const setStatus = (msg)=>{ if(status){ status.textContent = msg; status.style.display = "block"; } };
    const hideStatus = ()=>{ if(status){ status.style.display = "none"; } };

    // ===== 상단 연/월 UI 채우기 =====
    const yearLabel = document.getElementById("yearLabel");
    const prevYear = document.getElementById("prevYear");
    const nextYear = document.getElementById("nextYear");
    const monthbar = document.getElementById("monthbar");
    function go(y, m){
      const v = Date.now();
      const q = `?lang=${lang}&y=${y}&m=${m}&v=${v}`; // 캐시 버스터
      location.search = q;
    }
    function buildYearAndMonthUI(){
      yearLabel.textContent = `${year}년`;

      prevYear.onclick = ()=> go(String(parseInt(year,10)-1), month);
      nextYear.onclick = ()=> go(String(parseInt(year,10)+1), month);

      monthbar.innerHTML = "";
      for(let i=1;i<=12;i++){
        const mm = pad2(i);
        const a = document.createElement("a");
        a.href = "javascript:void(0)";
        a.textContent = `${i}월`;
        a.style.padding = "6px 10px";
        a.style.border = "1px solid #d1d5db";
        a.style.borderRadius = "999px";
        a.style.textDecoration = "none";
        a.style.color = (mm===month ? "#fff" : "#111827");
        a.style.background = (mm===month ? "#0b68d0" : "#fff");
        a.onclick = ()=> go(year, mm);
        monthbar.appendChild(a);
      }
    }

    // ===== 데이터 경로 후보 (두 가지 전략 순차 시도) =====
    // 1) 공통: data/2025-10.txt
    // 2) 언어별: data/2025-10.ko.txt
    const base = `data/${year}-${month}`;
    const candidates = [
      `${base}.txt`,
      `${base}.${lang}.txt`
    ];

    // ===== fetch with cache-buster =====
    async function fetchText(url){
      const v = Date.now();
      const res = await fetch(`${url}?v=${v}`, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);
      return await res.text();
    }

    async function loadData(){
      const errors = [];
      for(const url of candidates){
        try{
          const txt = await fetchText(url);
          return {url, txt};
        }catch(e){
          errors.push(e.message);
        }
      }
      throw new Error("데이터 파일을 찾지 못했습니다.\n" + errors.join("\n"));
    }

    // ===== 데이터 포맷: "DD|제목|링크" 또는 "DD|제목|본문약자|링크" =====
    function parseData(txt){
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const map = new Map();
      for(const line of lines){
        const parts = line.split("|").map(s=>s.trim());
        if(parts.length < 3) continue;
        const d = parts[0];
        if(!/^\d{1,2}$/.test(d)) continue;
        const day = String(parseInt(d,10));
        const title = parts[1] || "";
        let ref = "", href = "";
        if(parts.length === 3){ // DD|제목|링크
          href = parts[2];
        }else{                 // DD|제목|본문약자|링크
          ref  = parts[2];
          href = parts[3] || "";
        }
        map.set(day, {title, ref, href});
      }
      return map;
    }

    // ===== 달력 렌더링 =====
    function renderCalendar(map){
      const grid = document.getElementById("grid");
      if(!grid){ setStatus("grid 컨테이너가 없습니다."); return; }
      grid.innerHTML = "";

      const first = new Date(parseInt(year,10), parseInt(month,10)-1, 1);
      const last = new Date(parseInt(year,10), parseInt(month,10), 0);
      const startWeekday = first.getDay();
      const total = last.getDate();

      let day = 1;
      for(let r=0;r<6;r++){
        const row = document.createElement("div");
        row.className = "row";
        for(let c=0;c<7;c++){
          const idx = r*7+c;
          const cell = document.createElement("div");
          cell.className = "cell";
          if(idx < startWeekday || day > total){
            cell.innerHTML = "";
          }else{
            const info = map.get(String(day));
            const num = `<div class="d">${day}</div>`;
            if(info){
              const cap = info.ref ? `${info.title} <span class="ref">(${info.ref})</span>` : info.title;
              const body = info.href
                 ? `<a href="${info.href}" class="t" target="_blank" rel="noopener">${cap}</a>`
                 : `<div class="t">${cap}</div>`;
              cell.innerHTML = num + body;
            }else{
              cell.innerHTML = num + `<div class="t muted">제목 없음</div>`;
            }
            day++;
          }
          row.appendChild(cell);
        }
        grid.appendChild(row);
      }
    }

    // ===== 실행 =====
    (async()=>{
      try{
        hideStatus();
        buildYearAndMonthUI();
        const {url, txt} = await loadData();
        setStatus(`데이터 로드: ${url}`);
        const map = parseData(txt);
        renderCalendar(map);
      }catch(e){
        setStatus("오류: " + e.message);
        console.error(e);
      }
    })();
  })();
  </script>
</body>
